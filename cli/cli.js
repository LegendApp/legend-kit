#!/usr/bin/env node --no-warnings=ExperimentalWarning
import{render as hr}from"ink";import xr from"fs";import Bt from"path";import{fileURLToPath as yr}from"url";import{Box as pr,useInput as vt}from"ink";import Dt from"react";import{Box as Nt,Text as Ce}from"ink";import{jsx as be,jsxs as Lt}from"react/jsx-runtime";var pe=class extends Dt.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,o){console.error("Error caught by ErrorBoundary:",t),console.error("Component stack:",o.componentStack)}render(){var t;return this.state.hasError?this.props.fallback?this.props.fallback:Lt(Nt,{flexDirection:"column",borderStyle:"round",borderColor:"red",padding:1,children:[be(Ce,{bold:!0,color:"red",children:"Something went wrong"}),be(Ce,{color:"red",children:((t=this.state.error)==null?void 0:t.message)||"Unknown error"}),be(Ce,{children:"Please try again or check the logs for more details."})]}):this.props.children}};import{createContext as ro,useCallback as no,useContext as io}from"react";import{parse as Kt,stringify as _t}from"comment-json";import oe from"fs/promises";import Pe from"path";import{cwd as Ht}from"process";import{useEffect as Vt,useState as Je}from"react";import{useRef as Mt}from"react";function Q(e){let t=Mt(e);return Object.assign(t.current,e),t}import{useCallback as Jt,useRef as $t,useState as jt}from"react";function _(e){let[t,o]=jt(e),r=$t(e);r.current=t;let i=Jt(c=>{r.current=typeof c=="function"?c(r.current):c,o(r.current)},[]);return[t,i,r]}function Ut(e){return Kt(e)}function Wt(e){return _t(e,null,2)}function $(e,t){let[o,r,i]=_(null),[c,u]=Je(null),[p,h]=Je(!0),f=e?Pe.isAbsolute(e)?e:Pe.join(Ht(),e):void 0,s=t==="json"?Wt:void 0;Vt(()=>{(async()=>{if(!f){h(!1);return}try{h(!0);try{await oe.mkdir(Pe.dirname(f),{recursive:!0}),await oe.access(f)}catch{h(!1);return}let a=await oe.readFile(f,"utf-8"),l=t==="json"?Ut(a):void 0;r(l),u(null)}catch(a){console.error(a),u(a instanceof Error?a:new Error(String(a)))}finally{h(!1)}})()},[f]);let x=async g=>{let a=i.current;try{r(g),await oe.writeFile(f,s(g))}catch(l){console.error("Error saving tsconfig",l),u(l instanceof Error?l:new Error(String(l))),r(a)}},d=async(g,a)=>{let l=i.current;if(!l)throw new Error("Cannot update data that has not been loaded");try{let n={...l,[g]:a};r(n),await oe.writeFile(f,s(n))}catch(n){u(n instanceof Error?n:new Error(String(n))),r(l)}};return Q({filename:e,data:i.current,error:c,isLoading:p,setData:x,updateData:d}).current}var zt="legend-kit.json";function $e(){let{data:e,error:t,isLoading:o,updateData:r,setData:i}=$(zt,"json");return Q({config:e,error:t,isLoading:o,setConfigValue:r,setConfig:i}).current}import*as je from"fs";import Qt from"path";import{cwd as Gt}from"process";function Ke(e){let{data:t,error:o,isLoading:r,updateData:i,setData:c,filename:u}=$(Yt(e),"json");return Q({tsConfig:t,error:o,isLoading:r,setConfigValue:i,setConfig:c,filename:u}).current}function Yt(e){let t=(e==null?void 0:e.tsconfigPath)??"./tsconfig.json",o=Qt.join(Gt(),t);try{return je.accessSync(o),t}catch{return null}}import qt from"env-paths";import Zt from"path";var Xt=qt("legend-kit"),eo="auth";function _e(){let{data:e,error:t,isLoading:o,setData:r}=$(Zt.join(Xt.data,eo),"json");return{config:e,error:t,isLoading:o,setAuthConfig:r}}import{useEffect as to,useState as Se}from"react";function de(e,t,o={}){let[r,i]=Se(null),[c,u]=Se(!0),[p,h]=Se(null);return o.body&&(o.method="POST"),to(()=>{e&&(async()=>{try{u(!0);let s,x={method:o.method||"GET",headers:{"Content-Type":"application/json"},signal:t};o.method==="POST"&&o.body&&(x.body=JSON.stringify(o.body));let d=await fetch(e,x);if(!d.ok)throw new Error(`HTTP error! Status: ${d.status}`);s=await d.json(),i(s),h(null)}catch(s){h(s instanceof Error?s:new Error(String(s))),i(null)}finally{u(!1)}})()},[e]),{data:r,isLoading:c,error:p}}function He(e,t){return de(t?"https://production-legend-backend-w1C7WN.keelapps.xyz/kit/json/getRepoDownloadUrl":null,e,{body:{apiKey:t}})}import Ve from"fs";import Ue from"path";import{cwd as We}from"process";function ze(e){let{data:t,error:o,isLoading:r,updateData:i,setData:c,filename:u}=$(oo(e),"json");return{packageJSON:t,error:o,isLoading:r,setPackageValue:i,setPackage:c,filename:u}}function oo(e){let t=(e==null?void 0:e.packageJsonPath)??"./package.json",o=Ue.join(We(),t);try{return Ve.accessSync(o),t}catch{try{let i="./package.json";return Ve.accessSync(Ue.join(We(),i)),i}catch{return t}}}import{useApp as ao}from"ink";import{jsx as so}from"react/jsx-runtime";var Ge=ro(void 0),ge=new AbortController,Qe=ge.signal;process.on("SIGINT",()=>{ge.abort(),process.exit()});function Ye({flags:e,children:t}){var s;let{exit:o}=ao(),r=$e(),i=Ke(r.config||{}),c=_e(),u=ze(r.config||{}),{data:p}=He(Qe,((s=c==null?void 0:c.config)==null?void 0:s.apiKey)||""),h=no(()=>{console.log("aborting"),ge.abort(),o()},[ge]),f={configFile:r,config:r.config,tsConfig:i.tsConfig,tsConfigFile:i,authConfig:c.config,authConfigFile:c,proConfig:p,packageJSON:u.packageJSON,packageFile:u,abortSignal:Qe,exit:h};return so(Ge.Provider,{value:f,children:t})}function B(){let e=io(Ge);if(e===void 0)throw new Error("useAppConfig must be used within an AppConfigProvider");return e}import{useEffect as dr}from"react";import{Box as V,Text as U,useInput as Ro}from"ink";import Io from"open";import{useEffect as Do,useMemo as No,useRef as Lo,useState as X}from"react";import{Spinner as co}from"@inkjs/ui";import{Box as qe,Text as Ze}from"ink";import{useEffect as lo,useState as uo}from"react";import{jsx as me,jsxs as fo}from"react/jsx-runtime";function G({text:e,timeout:t,timeoutText:o}){let[r,i]=uo(!1);return lo(()=>{if(t){let c=setTimeout(()=>{i(!0)},t);return()=>{clearTimeout(c)}}},[t]),fo(qe,{children:[me(qe,{marginRight:1,children:r?me(Ze,{color:"red",children:"\u274C"}):me(co,{type:"dotsCircle"})}),me(Ze,{color:r?"red":void 0,children:r?o||"Operation timed out":e||"Loading..."})]})}import{Box as yo,useInput as ko}from"ink";import{useEffect as ot,useState as ve}from"react";import Xe from"figures";import{Box as po,Text as we}from"ink";import{jsx as Ee,jsxs as ho}from"react/jsx-runtime";var go=Xe.circle,mo=Xe.radioOn;function Y({label:e,checked:t,paddingLeft:o,hasCursor:r}){return Ee(po,{paddingLeft:o,children:ho(we,{children:[Ee(we,{color:"green",children:t?mo:go})," ",Ee(we,{bold:r,dimColor:!r,children:e})]})})}import{Box as re,Text as et}from"ink";import{jsx as q,jsxs as xo}from"react/jsx-runtime";function tt({data:e,columns:t,selectedRows:o=[],cursor:r=-1,padding:i=2,renderCell:c,getCellValue:u,getCellPadding:p}){let h=t.map((f,s)=>{let x=e.map(d=>{let g=p?p(f.key,d,s):0,a=u?u(f.key,d,s):String(d[f.key]);return typeof a=="string"?a.length+g:0});return Math.max(f.label.length,...x)+i});return xo(re,{flexDirection:"column",children:[q(re,{marginBottom:1,children:t.map((f,s)=>q(re,{width:h[s],children:q(et,{bold:!0,children:f.label})},s))}),e.map((f,s)=>{let x=s===r;return q(re,{children:t.map((d,g)=>{let a=u(d.key,f,s),l=c&&c(d.key,a,f,s,g);return typeof l=="string"?(a=l,l=void 0):typeof a=="boolean"&&(a=a?"Yes":"No"),q(re,{width:h[g],children:l||q(et,{dimColor:!x,children:a})},g)})},s)})]})}import{jsx as he}from"react/jsx-runtime";var rt=2,To=({options:e,onChange:t,onEnter:o,mode:r="checkbox",columns:i,renderCell:c})=>{let[u,p]=ve([]),[h,f]=ve(0),[s,x]=ve([]);ot(()=>{let a=g(e);x(a)},[e]),ot(()=>{t(u)},[u,t]);let d=a=>a.value||a.label,g=(a,l="",n=0)=>a.flatMap(m=>{var F;let b=d(m),C=l?`${l}/${b}`:b,S=[{option:m,path:C,depth:n}];return(F=m.children)!=null&&F.length&&S.push(...g(m.children,C,n+1)),S});if(ko((a,l)=>{if(l.upArrow)f(n=>Math.max(0,n-1));else if(l.downArrow)f(n=>Math.min(s.length-1,n+1));else if(l.return)o();else if(a==="a")u.length===s.length?p([]):p(s.map(n=>n.path));else if(a===" "){let{path:n}=s[h];p(m=>{if(m.includes(n))return m.filter(C=>!C.startsWith(n));{let C=s.filter(S=>S.path.startsWith(n)).map(S=>S.path);return[...m,...C.filter(S=>!m.includes(S))]}})}}),r==="table"){let a=s.map((l,n)=>u.includes(l.path)?n:-1).filter(l=>l!==-1);return he(tt,{data:s,columns:i,selectedRows:a,cursor:h,padding:4,getCellPadding:(l,n,m)=>m===0?4:0,renderCell:(l,n,m,b,C)=>{if(C===0){let{option:S,path:F,depth:z}=m,J=u.includes(F),L=b===h;return he(Y,{label:S.label,checked:J,paddingLeft:z*rt,hasCursor:L},F)}return c==null?void 0:c(l,n,m,b,C)},getCellValue:(l,n,m)=>n.option[l]})}return he(yo,{flexDirection:"column",children:s.map((a,l)=>{let{option:n,path:m,depth:b}=a,C=u.includes(m),S=l===h;return he(Y,{label:n.label,checked:C,paddingLeft:b*rt,hasCursor:S},m)})})},nt=To;import{useMemo as Co}from"react";var xe="https://raw.githubusercontent.com/LegendApp/legend-kit/refs/heads/main/";import it from"fs";import{createHash as bo}from"crypto";import{join as Po}from"path";function So(e){try{let o=it.readFileSync(e).toString().replace(/\r\n/g,`
`),r=bo("sha256");return r.update(o),r.digest("hex")}catch{return""}}function wo(e,t){let{file:o,sha:r,dir:i}=e,c=Po(t,i||"",o);try{if(it.accessSync(c),So(c)!==r)return!0}catch{return!0}return!1}function at(e,t=!1){let{data:o,error:r,isLoading:i}=de(`${xe}registry.json`,e),{config:c}=B(),{basePath:u}=c,{options:p,registry:h,numExcluded:f}=Co(()=>{if(!(o!=null&&o.packages)||!u)return{options:[],registry:{},numExcluded:0};let s=[],x={},d={},g=0;return o.packages.forEach(n=>{if(!wo(n,u))return;if(n.pro&&!t){g++;return}let m={label:n.name,value:n.name,package:n,...n};if(n.dir){let b=n.dir;x[b]||(x[b]=[]),x[b].push(m)}else s.push(m);d[n.dir?`${n.dir}/${n.name}`:n.name]=n}),{options:[...Object.entries(x).map(([n,m])=>({label:n,children:m.sort((b,C)=>b.label.localeCompare(C.label)),package:void 0})),...s].sort((n,m)=>n.label.localeCompare(m.label)),registry:d,numExcluded:g}},[o,u,t]);return{options:p,registry:h,error:r,isLoading:i,numExcluded:f}}import{Spinner as Eo}from"@inkjs/ui";import Be from"fs/promises";import{Box as ne,Text as Z}from"ink";import ie from"path";import{useEffect as vo,useState as Bo}from"react";import{jsx as j,jsxs as ae}from"react/jsx-runtime";function Fe({packages:e,registry:t,onComplete:o}){let{config:r,proConfig:i}=B(),[c,u]=Bo(()=>{let s={};return e.forEach(x=>{let d=x.dir?`${x.dir}/${x.name}`:x.name;s[d]="pending"}),{packageStatus:s,errors:{}}}),p=e.some(s=>s.pro),h=!p||i;if(vo(()=>{!r||!h||Fo({packages:e,registry:t,config:r,proConfig:i,onUpdateStatus:(s,x,d)=>{u(g=>{let a={...g.packageStatus,[s]:x},l={...g.errors};return d?l[s]=d.message:x!=="error"&&s in l&&delete l[s],x==="success"&&Object.values(a).every(n=>n==="success")&&setTimeout(()=>{o()},0),{packageStatus:a,errors:l}})}})},[h,r]),p&&!i)return j(G,{text:"Connecting to Legend Kit server...",timeout:1e4,timeoutText:"Failed to connect to Legend Kit server. Please check your connection."});let f=Object.values(c.packageStatus).reduce((s,x)=>(s[x]++,s),{pending:0,installing:0,success:0,error:0});return ae(ne,{flexDirection:"column",children:[ae(Z,{bold:!0,children:["Installing packages... (",f.success+f.error,"/",e.length,")"]}),j(ne,{flexDirection:"column",marginTop:1,children:e.map(s=>{let x=s.dir?`${s.dir}/${s.name}`:s.name,d=c.packageStatus[x],g=c.errors[x];return ae(ne,{flexDirection:"row",children:[ae(ne,{width:2,marginRight:1,children:[d==="installing"&&j(Eo,{type:"dotsCircle"}),d==="success"&&j(Z,{color:"green",children:"\u2713"}),d==="error"&&j(Z,{color:"red",children:"\u2717"}),d==="pending"&&j(Z,{color:"gray",children:"\u22EF"})]}),ae(ne,{flexDirection:"column",children:[j(Z,{dimColor:d!=="success",children:x}),g&&j(Z,{color:"red",dimColor:!0,children:g})]})]},x)})})]})}async function Fo({packages:e,registry:t,config:o,proConfig:r,onUpdateStatus:i}){let c=`${xe}packages/`,{basePath:u}=o;if(!u)throw new Error("Base path not defined in config");let p=new Set,h=f=>{f&&(p.add(f),f.imports&&f.imports.length>0&&f.imports.forEach(s=>{let x=t[s]||t[`${f.dir}/${s}`];x&&!p.has(x)&&h(x)}))};e.forEach(f=>h(f)),await Promise.all(Array.from(p).map(async f=>{let s=f.dir?`${f.dir}/${f.name}`:f.name,x=f.pro?r.baseUrl:c;i==null||i(s,"installing");try{let d=ie.join(u,f.dir||""),g=f.file;if(!g)throw new Error(`No file defined for package: ${s}`);let a=g.includes("/")?"..":"",l=ie.join(d,a,g);try{try{await Be.access(ie.dirname(l))}catch{await Be.mkdir(ie.dirname(l),{recursive:!0})}}catch(C){throw new Error(`Failed to create directory: ${C instanceof Error?C.message:String(C)}`)}let n=ie.join(x,f.dir||"",a,g),m;if(f.pro?m=await fetch(n,{headers:{Authorization:`token ${r.token}`,Accept:"application/vnd.github.v3.raw"}}):m=await fetch(n),!m.ok)throw new Error(`Failed to fetch ${g}: ${m.status} ${m.statusText}`);let b=await m.text();await Be.writeFile(l,b,"utf-8"),i==null||i(s,"success")}catch(d){i==null||i(s,"error",d instanceof Error?d:new Error(String(d)))}}))}import{Text as Ao}from"ink";import{jsxs as Oo}from"react/jsx-runtime";function H({text:e}){return Oo(Ao,{color:"cyan",children:["<",e,">"]})}import{jsx as E,jsxs as ye}from"react/jsx-runtime";var st=({input:e})=>{let{exit:t,abortSignal:o,authConfig:r}=B(),i=!!(r!=null&&r.apiKey),{options:c,registry:u,error:p,isLoading:h,numExcluded:f}=at(o,i),[s,x]=X(null),[d,g]=X(!1),[a,l]=X(p),n=Lo(!1),m=e.length>1?e.slice(1):[];Do(()=>{if(n.current||h||p||!u||m.length===0)return;n.current=!0;let C=[],S=[];m.forEach(F=>{let z=Object.values(u).find(J=>J.name===F||J.dir&&`${J.dir}/${J.name}`===F);z?C.push(z):S.push(F)}),S.length>0?l(new Error(`Packages not found: ${S.join(", ")}`)):C.length>0?x(C):setTimeout(()=>{t()},1e3)},[h,p,u,m,t]);let b=()=>{g(!0),setTimeout(()=>{t()},1e3)};return d?E(U,{children:"Installation complete"}):s?E(Fe,{packages:s,registry:u,onComplete:b}):h?E(G,{}):a||p?(setTimeout(()=>{t()},1e3),E(V,{children:ye(U,{children:["Error: ",(a==null?void 0:a.message)||(p==null?void 0:p.message)]})})):m.length>0&&n.current?E(V,{children:E(U,{children:"No packages found to install."})}):c?E(Mo,{options:c,registry:u,numExcluded:f}):null};function Mo({options:e,registry:t,numExcluded:o}){let{exit:r,authConfig:i}=B(),c=!!(i!=null&&i.apiKey),[u,p]=X([]),[h,f]=X(null),[s,x]=X(!1),d=u.map(n=>t[n]).filter(Boolean),g=()=>{d.length>0&&f(d)};Ro((n,m)=>{n==="p"&&Io("https://www.legendapp.com/kit")});let a=()=>{x(!0),setTimeout(()=>{r()},1e3)},l=No(()=>{let n=[{label:"Package",key:"name"},{label:"Platform",key:"platform"},{label:"Type",key:"type"},{label:"Pro",key:"pro"},{label:"Description",key:"description"}];return c?n:n.filter(m=>m.key!=="pro")},[c]);return s?E(U,{children:"Installation complete"}):h?E(Fe,{packages:h,registry:t,onComplete:a}):ye(V,{flexDirection:"column",gap:1,children:[E(V,{children:E(U,{bold:!0,children:"\u{1F4E6} Select packages"})}),!c&&E(V,{children:ye(U,{dimColor:!0,children:["Excluding ",o," Pro packages. Press ",E(H,{text:"p"})," to learn more about Legend Kit Pro."]})}),E(V,{marginTop:1,children:E(nt,{mode:"table",columns:l,options:e,onChange:p,onEnter:g,renderCell:(n,m,b,C,S)=>{if(n==="pro"&&b.option.package)return console.log(b.option.package),m?"Pro":""}})}),E(V,{flexDirection:"column",marginTop:1,children:ye(U,{bold:!0,dimColor:u.length===0,children:["Press ",E(H,{text:"Enter"})," to install ",d.length," packages"]})})]})}import{Box as se,Text as M,useInput as Qo}from"ink";import{useState as ut}from"react";import Wo from"node:http";import zo from"open";import Jo from"node:crypto";import{EOL as $o,endianness as jo}from"node:os";import{baseboard as Ko,bios as _o,cpu as Ho,osInfo as Vo,system as Uo}from"systeminformation";async function ct(){let{manufacturer:e,model:t,serial:o,uuid:r}=await Uo(),{vendor:i,version:c,releaseDate:u}=await _o(),{manufacturer:p,model:h,serial:f}=await Ko(),{manufacturer:s,brand:x,speedMax:d,cores:g,physicalCores:a,socket:l}=await Ho(),{platform:n,arch:m}=await Vo(),b={EOL:$o,endianness:jo(),manufacturer:e,model:t,serial:o,uuid:r,vendor:i,biosVersion:c,releaseDate:u,boardManufacturer:p,boardModel:h,boardSerial:f,cpuManufacturer:s,brand:x,speedMax:d.toFixed(2),cores:g,physicalCores:a,socket:l,platform:n,arch:m},C=JSON.stringify(b);return Jo.createHash("sha256").update(C).digest("hex")}async function lt(){return new Promise((e,t)=>{let o=Wo.createServer((i,c)=>{try{let p=new URL(i.url||"",`http://${i.headers.host}`).searchParams.get("apiKey");p?(c.writeHead(200,{"Content-Type":"text/html"}),c.end(`
            <html>
              <body>
                <h1>Authentication successful!</h1>
                <p>You can close this window and return to the CLI.</p>
                <script>window.close();</script>
              </body>
            </html>
          `),e(p),o.close()):(c.writeHead(400,{"Content-Type":"text/html"}),c.end(`
            <html>
              <body>
                <h1>Authentication failed</h1>
                <p>No authentication token received. Please try again.</p>
              </body>
            </html>
          `))}catch(u){t(u),c.writeHead(500,{"Content-Type":"text/plain"}),c.end("Authentication error occurred"),o.close()}});o.listen(0,()=>{try{let u=`http://localhost:${o.address().port}`;(async()=>{let p=await ct(),f=`https://www.legendapp.com/kit/auth?redirectUri=${encodeURIComponent(u)}#deviceId=${p}`;await zo(f)})()}catch(i){o.close(),t(new Error(`Failed to start authentication process: ${i}`))}});let r=5*60*1e3;setTimeout(()=>{o.close(),t(new Error("Authentication timed out after 5 minutes"))},r)})}import{jsx as O,jsxs as ke}from"react/jsx-runtime";var Go=({goBack:e})=>{let{authConfigFile:t,authConfig:o}=B(),[r,i]=ut(o!=null&&o.apiKey?"authenticated":"waiting"),[c,u]=ut(null),p=async()=>{try{i("authenticating");let h=await lt();await t.setAuthConfig({apiKey:h}),i("authenticated")}catch(h){i("failed"),u(h.message)}};return Qo((h,f)=>{f.return&&(r==="waiting"||r==="failed"?p():r==="authenticated"&&e())}),c?ke(se,{flexDirection:"column",children:[O(M,{color:"red",children:"Authentication failed:"}),O(M,{color:"red",children:c}),O(se,{marginTop:1,children:O(M,{children:"Press Enter to try again"})})]}):r==="waiting"?O(se,{children:O(M,{children:"Press Enter to open a browser to authenticate"})}):r==="authenticating"?ke(se,{flexDirection:"column",children:[O(M,{children:"Browser opened for authentication..."}),O(M,{children:"Please complete the login process in your browser."}),O(M,{bold:!0,children:"Waiting for authentication to complete..."})]}):r==="authenticated"?ke(se,{children:[O(M,{color:"green",children:"You are authenticated! "}),ke(M,{children:["Press ",O(H,{text:"Enter"})," to go back!"]})]}):null},ft=Go;import{Select as Yo}from"@inkjs/ui";import{Box as ee,Text as K}from"ink";import{Fragment as Xo,jsx as R,jsxs as te}from"react/jsx-runtime";var qo=[{label:"add  - Add a package to your project",value:"add"},{label:"auth - Authenticate with Legend Kit for Pro features",value:"auth"},{label:te(Xo,{children:["exit - Press ",R(H,{text:"q"})," at any time to exit"]}),value:"exit"}],Zo=({setCommand:e})=>te(ee,{flexDirection:"column",children:[R(ee,{marginBottom:1,children:R(K,{dimColor:!0,italic:!0,children:"A command-line tool for Legend Kit"})}),te(ee,{flexDirection:"column",marginBottom:1,children:[R(K,{bold:!0,children:"What would you like to do?"}),R(ee,{children:R(K,{dimColor:!0,children:"Select a command from the list below to get started"})})]}),R(ee,{flexDirection:"column",children:R(Yo,{options:qo,onChange:e})}),te(ee,{flexDirection:"column",marginY:2,children:[te(K,{dimColor:!0,children:["Press ",R(K,{bold:!0,children:"\u2191"})," or ",R(K,{bold:!0,children:"\u2193"})," to navigate"]}),te(K,{dimColor:!0,children:["Press ",R(K,{bold:!0,children:"Enter"})," to select"]})]})]}),pt=Zo;import{Text as bt}from"ink";import Ae from"fs";import{Text as kt}from"ink";import Te from"path";import{useRef as ir,useState as Oe}from"react";import{useState as ce}from"react";import{Box as T,Text as w,useInput as gt}from"ink";import{TextInput as er}from"@inkjs/ui";import{jsx as y,jsxs as v}from"react/jsx-runtime";var tr="\u256D",W="\u2502",or="\u2570";var dt="\u25C8",rr=({value:e,placeholder:t,onSubmit:o,onChange:r,error:i})=>v(T,{flexDirection:"column",children:[y(er,{placeholder:t,defaultValue:e,onSubmit:o,onChange:r}),i&&y(T,{marginTop:1,children:y(w,{color:"red",children:i})})]}),nr=({value:e,onChange:t,error:o})=>{let[r,i]=ce(e===!1?"no":"yes");gt((p,h)=>{h.leftArrow?i("yes"):h.rightArrow?i("no"):h.return?t(r==="yes"):p==="y"||p==="Y"?t(!0):(p==="n"||p==="N")&&t(!1)});let c=r==="yes",u=r==="no";return v(T,{flexDirection:"column",children:[v(T,{flexDirection:"row",children:[y(T,{children:y(Y,{label:"Yes",checked:c,paddingLeft:0,hasCursor:c})}),y(w,{children:" / "}),y(T,{children:y(Y,{label:"No",checked:u,paddingLeft:0,hasCursor:u})})]}),o&&y(T,{marginTop:1,children:y(w,{color:"red",children:o})})]})},le=({title:e,questions:t,onSubmit:o,onCancel:r})=>{let[i,c]=ce(0),[u,p,h]=_({}),[f,s]=ce(""),[x,d,g]=_(null),[a,l]=ce(0),[n,m]=ce(null);gt((P,k)=>{k.escape&&r&&r(),k.upArrow&&S()});let b=(P,k)=>{p(A=>({...A,[P]:k}))},C=()=>{if(i<t.length&&t[i]){let k=t[i],A;if(k.type==="boolean"?A=g.current??k.placeholder:A=f||k.placeholder||"",k.validate){let I=k.validate(A);if(I!==!0){m(I);return}}m(null),b(k.id,A)}let P=i+1;for(;P<t.length;){let k=t[P];if(k&&k.skip&&k.skip())P++;else break}if(P<t.length){c(P);let k=t[P];(k==null?void 0:k.default)!==void 0?k.type==="boolean"?d(k.default??null):s(k.default??""):(s(""),d(null)),l(A=>A+1)}else o(h.current)},S=()=>{if(i>0){let P=i-1;for(;P>=0;){let k=t[P];if(k&&k.skip&&k.skip())P--;else break}if(P>=0){c(P);let k=t[P];if(k){let A=k.id;if(k.type==="boolean"){let I=u[A]??k.placeholder;d(typeof I=="boolean"?I:null)}else{let I=u[A];s(typeof I=="string"?I:"")}l(I=>I+1)}}}},F=P=>{s(P)},z=P=>{d(P),C()},J=()=>{C()},L=t[i];if(!L)return y(w,{children:"No questions available"});let Ot=L.type==="boolean",Rt=t.slice(0,i),It=(P,k)=>k===void 0?"":P==="boolean"?k===!0?"Yes":"No":String(k);return v(T,{flexDirection:"column",children:[v(T,{flexDirection:"row",children:[y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:tr})}),y(T,{marginLeft:2,children:v(w,{backgroundColor:"cyan",bold:!0,children:[" ",e," "]})})]}),y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:W})})}),Rt.map((P,k)=>v(T,{flexDirection:"column",children:[y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:W})})}),v(T,{flexDirection:"row",gap:1,children:[y(w,{color:"green",children:dt}),v(w,{dimColor:!0,children:[" ",P.prompt]})]}),v(T,{flexDirection:"row",gap:1,children:[y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:W})}),y(T,{marginLeft:2,children:u[P.id]!==void 0?y(w,{color:"gray",children:It(P.type,u[P.id])}):null})]}),y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:W})})})]},`past-${P.id}`)),v(T,{flexDirection:"column",children:[y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{dimColor:!0,children:W})})}),v(T,{flexDirection:"row",gap:1,children:[y(w,{color:"blue",bold:!0,children:dt}),v(T,{children:[v(w,{color:"white",bold:!0,children:[" ",L.prompt]}),L.helperText&&v(w,{color:"gray",italic:!0,children:[" ","(",L.helperText,")"]})]})]}),v(T,{flexDirection:"row",children:[y(T,{width:1,alignItems:"center",children:y(w,{color:"blue",bold:!0,children:W})}),y(T,{marginLeft:2,children:Ot?y(nr,{value:L.placeholder,onChange:z,error:n||void 0},a):y(rr,{placeholder:L.placeholder,value:f,onSubmit:J,onChange:F,error:n||void 0},a)})]}),y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{color:"blue",bold:!0,children:W})})})]}),y(T,{flexDirection:"row",children:y(T,{width:1,alignItems:"center",children:y(w,{color:"blue",bold:!0,children:or})})})]})};function mt(e,t){if(!e.packageJSON)return!1;let{packageJSON:o}=e;return!!(o.scripts&&o.scripts[t])}async function ht({packageFile:e,scriptName:t,scriptCommand:o="npx legend-kit"}){if(!e.packageJSON)throw new Error("Package.json not loaded");try{let{packageJSON:r}=e,i={...r.scripts||{},[t]:o};await e.setPackageValue("scripts",i)}catch(r){let i=r instanceof Error?r.message:String(r);throw new Error(`Failed to update package.json script: ${i}`)}}function xt({tsConfigFile:e}){var o;if(!e.tsConfig)return!1;let t=(o=e.tsConfig.compilerOptions)==null?void 0:o.paths;return!(!t||!t["@legend-kit"])}async function yt({tsConfigFile:e,config:t}){if(!e.tsConfig)throw console.error(e),new Error("TSConfig not loaded");try{let o={...e.tsConfig};o.compilerOptions||(o.compilerOptions={paths:{}}),o.compilerOptions.paths||(o.compilerOptions.paths={}),o.compilerOptions.paths={...o.compilerOptions.paths,"@legend-kit":[t.basePath]},await e.setConfig(o)}catch(o){let r=o instanceof Error?o.message:String(o);throw new Error(`Failed to update tsconfig.json: ${r}`)}}import{Fragment as Tt,jsx as ue,jsxs as Re}from"react/jsx-runtime";function Ct({configFile:e,tsConfigFile:t,packageFile:o}){let r=ir(!1),[i,c]=Oe(!1),[u,p]=Oe(null),[h,f]=Oe(!1),s=[{id:"basePath",prompt:"Where should we install the packages?",placeholder:"./legend-kit",type:"text"},{id:"auth",prompt:"Do you want to authenticate with your account to access Pro packages?",placeholder:!1,type:"boolean"},{id:"tsconfigPath",prompt:"Where is your tsconfig.json file?",placeholder:t.filename||"./tsconfig.json",type:"text",validate:g=>{let a=g;if(!a||a.trim()==="")return"Please provide a path to your tsconfig.json file";let l=Te.isAbsolute(a)?a:Te.resolve(process.cwd(),a);return Ae.existsSync(l)?l.endsWith(".json")?!0:"The file must be a JSON file":`File not found at: ${l}`}},{id:"scriptName",prompt:"What script name would you like to add to package.json to run legend kit? (leave blank to skip)",default:"legend",type:"text",validate:g=>{let a=g;return r.current=a.trim()==="",a.trim()===""||/^[a-zA-Z0-9_-]+$/.test(a)?!0:"Script name can only contain letters, numbers, dashes, and underscores"}},{id:"packageJsonPath",prompt:"Where is your package.json file?",placeholder:"./package.json",type:"text",skip:()=>r.current,validate:g=>{let a=g;if(!a||a.trim()==="")return"Please provide a path to your package.json file";let l=Te.isAbsolute(a)?a:Te.resolve(process.cwd(),a);if(!Ae.existsSync(l))return`File not found at: ${l}`;if(!l.endsWith(".json"))return"The file must be a JSON file";try{let n=JSON.parse(Ae.readFileSync(l,"utf8"));if(!(n.name||n.private||n.scripts||n.dependencies||n.devDependencies))return"Invalid package.json file"}catch(n){return`Invalid JSON file: ${n.message}`}return!0}}],x=(g,a,l)=>new Promise((n,m)=>{let b=setTimeout(()=>{m(new Error(l))},a);g.then(C=>{clearTimeout(b),n(C)}).catch(C=>{clearTimeout(b),m(C)})}),d=async g=>{c(!0),p(null);let a={configSaved:!1,tsConfigUpdated:!1,packageUpdated:!1};try{let l=r.current;try{await x(e.setConfig({basePath:g.basePath,authenticate:g.auth,tsconfigPath:g.tsconfigPath,scriptName:l?void 0:g.scriptName,packageJsonPath:l?void 0:g.packageJsonPath}),1e4,"Config save operation timed out"),a.configSaved=!0}catch(n){throw new Error(`Failed to save configuration: ${n instanceof Error?n.message:String(n)}`)}try{xt({tsConfigFile:t})||await x(yt({tsConfigFile:t,config:e.config}),1e4,"TSConfig update operation timed out"),a.tsConfigUpdated=!0}catch(n){console.error("TSConfig update failed:",n)}if(l)a.packageUpdated=!0;else try{let n=g.scriptName;mt(o,n)||await x(ht({packageFile:o,scriptName:n,scriptCommand:"npx @legendapp/kit@latest"}),1e4,"Package.json update operation timed out"),a.packageUpdated=!0}catch(n){console.error("Package.json update failed:",n)}f(!0)}catch(l){let n=l instanceof Error?l.message:String(l);a.configSaved&&(n+=`
Config was saved successfully.`),a.tsConfigUpdated&&(n+=`
TSConfig was updated successfully.`),a.packageUpdated&&(n+=`
Package.json was updated successfully.`),p(new Error(n))}finally{c(!1)}};return i?ue(le,{title:"Initializing Legend Kit...",questions:s,onSubmit:d}):u?Re(Tt,{children:[ue(le,{title:"Initializing Legend Kit...",questions:s,onSubmit:d}),Re(kt,{color:"red",children:["Error during initialization: ",u.message]})]}):h?Re(Tt,{children:[ue(le,{title:"Initializing Legend Kit...",questions:s,onSubmit:d}),ue(kt,{color:"green",children:"\u2713 Legend Kit initialized successfully!"})]}):ue(le,{title:"Initializing Legend Kit...",questions:s,onSubmit:d})}import{jsx as Ie,jsxs as ar}from"react/jsx-runtime";function De(){let e=Ne(),{configFile:t,tsConfigFile:o,packageFile:r}=B();return e==="config-loading"?Ie(G,{text:"Loading config..."}):e==="config-error"?ar(bt,{color:"red",children:["Error: ",t.error.message]}):e==="config-missing"?Ie(Ct,{configFile:t,tsConfigFile:o,packageFile:r}):Ie(bt,{children:"Legend Kit is already initialized"})}function Ne(){let{configFile:e}=B();return e.isLoading?"config-loading":e.error?"config-error":e.config?!1:"config-missing"}import{Box as sr,Text as cr}from"ink";import{jsx as Pt}from"react/jsx-runtime";var lr=()=>Pt(sr,{children:Pt(cr,{children:"status"})}),St=lr;import{Box as fe,Text as wt}from"ink";import Le from"ink-gradient";import ur from"ink-big-text";import{jsx as D,jsxs as fr}from"react/jsx-runtime";function Et(){return D(fe,{flexDirection:"column",marginBottom:1,children:fr(fe,{flexDirection:"column",children:[D(fe,{children:D(Le,{name:"vice",children:D(wt,{bold:!0,children:"\u256D\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256E"})})}),D(fe,{marginTop:-2,marginBottom:-1,flexDirection:"row",children:D(Le,{name:"vice",children:D(ur,{text:"Legend Kit",font:"simple"})})}),D(fe,{children:D(Le,{name:"vice",children:D(wt,{bold:!0,children:"\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256F"})})})]})})}import{jsx as N,jsxs as mr}from"react/jsx-runtime";function Me({input:e,flags:t}){var c;let[o,r,i]=_(((c=e[0])==null?void 0:c.toLowerCase())||null);return vt((u,p)=>{p.escape&&i.current&&r(null)}),N(pe,{children:N(Ye,{input:e,flags:t,children:mr(pr,{padding:1,flexDirection:"column",children:[N(Et,{}),N(gr,{command:o,setCommand:r,input:e})]})})})}function gr({command:e,setCommand:t,input:o}){let r=Ne(),{exit:i}=B();if(vt((c,u)=>{(u.escape||c==="q")&&i()}),dr(()=>{e==="exit"&&i()},[e]),r)return N(De,{});switch(e){case"add":return N(st,{input:o});case"auth":return N(ft,{goBack:()=>t(null)});case"status":return N(St,{});case"init":return N(De,{});default:return N(pt,{setCommand:t})}}import{jsx as Cr}from"react/jsx-runtime";process.on("uncaughtException",e=>{console.error("Uncaught Exception:"),console.error(e),process.exit(1)});process.on("unhandledRejection",(e,t)=>{console.error("Unhandled Promise Rejection:"),console.error("Promise:",t),console.error("Reason:",e),process.exit(1)});function kr(){let e=process.argv.slice(2),t=[],o={};for(let r of e)if(r.startsWith("--")){let i=r.slice(2),c=i.indexOf("=");if(c!==-1){let u=i.slice(0,c),p=i.slice(c+1);o[u]=p}else o[i]=!0}else r==="-v"||r==="-version"?o.version=!0:t.push(r);return{input:t,flags:o}}function Tr(){try{let e=yr(import.meta.url),t=Bt.dirname(e),o=Bt.resolve(t,"package.json");return JSON.parse(xr.readFileSync(o,"utf8")).version||"unknown"}catch(e){return console.error("Error reading package version:",e),"unknown"}}var{input:Ft,flags:At}=kr();At.version&&Ft.length===0&&(console.log(`v${Tr()}`),process.exit(0));try{hr(Cr(Me,{input:Ft,flags:At}))}catch(e){console.error("Error rendering application:"),console.error(e),process.exit(1)}
