#!/usr/bin/env node --no-warnings=ExperimentalWarning
import{render as pr}from"ink";import dr from"fs";import Et from"path";import{fileURLToPath as gr}from"url";import{Box as ar,useApp as sr,useInput as cr}from"ink";import{useCallback as Rt,useRef as Dt,useState as It}from"react";function U(e){let[t,r]=It(e),o=Dt(e);o.current=t;let n=Rt(l=>{o.current=typeof l=="function"?l(o.current):l,r(o.current)},[]);return[t,n,o]}import{createContext as eo,useContext as to}from"react";import{parse as Lt,stringify as Mt}from"comment-json";import X from"fs/promises";import ye from"path";import{cwd as Jt}from"process";import{useEffect as $t,useState as Le}from"react";import{useRef as Nt}from"react";function H(e){let t=Nt(e);return Object.assign(t.current,e),t}function jt(e){return Lt(e)}function Kt(e){return Mt(e,null,2)}function J(e,t){let[r,o,n]=U(null),[l,f]=Le(null),[m,g]=Le(!0),p=e?ye.isAbsolute(e)?e:ye.join(Jt(),e):void 0,c=t==="json"?Kt:void 0;$t(()=>{(async()=>{if(!p){g(!1);return}try{g(!0);try{await X.mkdir(ye.dirname(p),{recursive:!0}),await X.access(p)}catch{g(!1);return}let i=await X.readFile(p,"utf-8"),s=t==="json"?jt(i):void 0;o(s),f(null)}catch(i){console.error(i),f(i instanceof Error?i:new Error(String(i)))}finally{g(!1)}})()},[p]);let h=async d=>{let i=n.current;try{o(d),await X.writeFile(p,c(d))}catch(s){console.error("Error saving tsconfig",s),f(s instanceof Error?s:new Error(String(s))),o(i)}},u=async(d,i)=>{let s=n.current;if(!s)throw new Error("Cannot update data that has not been loaded");try{let a={...s,[d]:i};o(a),await X.writeFile(p,c(a))}catch(a){f(a instanceof Error?a:new Error(String(a))),o(s)}};return H({filename:e,data:n.current,error:l,isLoading:m,setData:h,updateData:u}).current}var _t="legend-kit.json";function Me(){let{data:e,error:t,isLoading:r,updateData:o,setData:n}=J(_t,"json");return H({config:e,error:t,isLoading:r,setConfigValue:o,setConfig:n}).current}import*as Je from"fs";import Ut from"path";import{cwd as Vt}from"process";function $e(e){let{data:t,error:r,isLoading:o,updateData:n,setData:l,filename:f}=J(Ht(e),"json");return H({tsConfig:t,error:r,isLoading:o,setConfigValue:n,setConfig:l,filename:f}).current}function Ht(e){let t=(e==null?void 0:e.tsconfigPath)??"./tsconfig.json",r=Ut.join(Vt(),t);try{return Je.accessSync(r),t}catch{return null}}import Wt from"env-paths";import zt from"path";var Qt=Wt("legend-kit"),Yt="auth";function je(){let{data:e,error:t,isLoading:r,setData:o}=J(zt.join(Qt.data,Yt),"json");return{config:e,error:t,isLoading:r,setAuthConfig:o}}import{useState as ke,useEffect as Gt}from"react";import Zt from"fs/promises";import qt from"path";function ue(e,t={}){let[r,o]=ke(null),[n,l]=ke(!0),[f,m]=ke(null),g=void 0;return t.body&&(t.method="POST"),Gt(()=>{e&&(async()=>{try{l(!0);let c;if(g){let u=new URL(e).pathname.split("/"),d=u[u.length-1]||"index.json",i=qt.join(process.cwd(),"testdata",d);try{let s=await Zt.readFile(i,"utf-8");c=JSON.parse(s)}catch(s){throw new Error(`Failed to read test data file: ${i}. ${s instanceof Error?s.message:String(s)}`)}}else{let h={method:t.method||"GET",headers:{"Content-Type":"application/json"}};t.method==="POST"&&t.body&&(h.body=JSON.stringify(t.body));let u=await fetch(e,h);if(!u.ok)throw new Error(`HTTP error! Status: ${u.status}`);c=await u.json()}o(c),m(null)}catch(c){m(c instanceof Error?c:new Error(String(c))),o(null)}finally{l(!1)}})()},[e,g]),{data:r,isLoading:n,error:f}}function Ke(e){return ue(e?"https://production-legend-backend-w1C7WN.keelapps.xyz/kit/json/getRepoDownloadUrl":null,{body:{apiKey:e}})}import _e from"fs";import Ue from"path";import{cwd as Ve}from"process";function He(e){let{data:t,error:r,isLoading:o,updateData:n,setData:l,filename:f}=J(Xt(e),"json");return{packageJSON:t,error:r,isLoading:o,setPackageValue:n,setPackage:l,filename:f}}function Xt(e){let t=(e==null?void 0:e.packageJsonPath)??"./package.json",r=Ue.join(Ve(),t);try{return _e.accessSync(r),t}catch{try{let n="./package.json";return _e.accessSync(Ue.join(Ve(),n)),n}catch{return t}}}import{jsx as oo}from"react/jsx-runtime";var We=eo(void 0);function ze({flags:e,children:t}){var g;let r=Me(),o=$e(r.config||{}),n=je(),l=He(r.config||{}),{data:f}=Ke(((g=n==null?void 0:n.config)==null?void 0:g.apiKey)||""),m={testData:e.useTestData,configFile:r,config:r.config,tsConfig:o.tsConfig,tsConfigFile:o,authConfig:n.config,authConfigFile:n,proConfig:f,packageJSON:l.packageJSON,packageFile:l};return oo(We.Provider,{value:m,children:t})}function O(){let e=to(We);if(e===void 0)throw new Error("useAppConfig must be used within an AppConfigProvider");return e}import ro from"react";import{Box as no,Text as Te}from"ink";import{jsx as Ce,jsxs as io}from"react/jsx-runtime";var fe=class extends ro.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,r){console.error("Error caught by ErrorBoundary:",t),console.error("Component stack:",r.componentStack)}render(){var t;return this.state.hasError?this.props.fallback?this.props.fallback:io(no,{flexDirection:"column",borderStyle:"round",borderColor:"red",padding:1,children:[Ce(Te,{bold:!0,color:"red",children:"Something went wrong"}),Ce(Te,{color:"red",children:((t=this.state.error)==null?void 0:t.message)||"Unknown error"}),Ce(Te,{children:"Please try again or check the logs for more details."})]}):this.props.children}};import Bo from"open";import{Box as j,Text as B,useApp as it,useInput as Fo}from"ink";import{useMemo as nt,useState as Z,useEffect as Oo,useRef as Ao}from"react";import{Spinner as ao}from"@inkjs/ui";import{Box as Qe,Text as Ye}from"ink";import{useEffect as so,useState as co}from"react";import{jsx as pe,jsxs as lo}from"react/jsx-runtime";function W({text:e,timeout:t,timeoutText:r}){let[o,n]=co(!1);return so(()=>{if(t){let l=setTimeout(()=>{n(!0)},t);return()=>{clearTimeout(l)}}},[t]),lo(Qe,{children:[pe(Qe,{marginRight:1,children:o?pe(Ye,{color:"red",children:"\u274C"}):pe(ao,{type:"dotsCircle"})}),pe(Ye,{color:o?"red":void 0,children:o?r||"Operation timed out":e||"Loading..."})]})}import{Box as ho,useInput as xo}from"ink";import{useEffect as Xe,useState as Se}from"react";import Ge from"figures";import{Box as uo,Text as be}from"ink";import{jsx as Pe,jsxs as go}from"react/jsx-runtime";var fo=Ge.circle,po=Ge.radioOn;function z({label:e,checked:t,paddingLeft:r,hasCursor:o}){return Pe(uo,{paddingLeft:r,children:go(be,{children:[Pe(be,{color:"green",children:t?po:fo})," ",Pe(be,{bold:o,dimColor:!o,children:e})]})})}import{Box as ee,Text as Ze}from"ink";import{jsx as Q,jsxs as mo}from"react/jsx-runtime";function qe({data:e,columns:t,selectedRows:r=[],cursor:o=-1,padding:n=2,renderCell:l,getCellValue:f,getCellPadding:m}){let g=t.map((p,c)=>{let h=e.map(u=>{let d=m?m(p.key,u,c):0,i=f?f(p.key,u,c):String(u[p.key]);return typeof i=="string"?i.length+d:0});return Math.max(p.label.length,...h)+n});return mo(ee,{flexDirection:"column",children:[Q(ee,{marginBottom:1,children:t.map((p,c)=>Q(ee,{width:g[c],children:Q(Ze,{bold:!0,children:p.label})},c))}),e.map((p,c)=>{let h=c===o;return Q(ee,{children:t.map((u,d)=>{let i=f(u.key,p,c);typeof i=="boolean"&&(i=i?"Yes":"No");let s=l&&l(u.key,i,p,c,d);return Q(ee,{width:g[d],children:s||Q(Ze,{dimColor:!h,children:i})},d)})},c)})]})}import{jsx as de}from"react/jsx-runtime";var et=2,yo=({options:e,onChange:t,onEnter:r,mode:o="checkbox",columns:n,renderCell:l})=>{let[f,m]=Se([]),[g,p]=Se(0),[c,h]=Se([]);Xe(()=>{let i=d(e);h(i)},[e]),Xe(()=>{t(f)},[f,t]);let u=i=>i.value||i.label,d=(i,s="",a=0)=>i.flatMap(y=>{var _;let P=u(y),C=s?`${s}/${P}`:P,E=[{option:y,path:C,depth:a}];return(_=y.children)!=null&&_.length&&E.push(...d(y.children,C,a+1)),E});if(xo((i,s)=>{if(s.upArrow)p(a=>Math.max(0,a-1));else if(s.downArrow)p(a=>Math.min(c.length-1,a+1));else if(s.return)r();else if(i==="a")f.length===c.length?m([]):m(c.map(a=>a.path));else if(i===" "){let{path:a}=c[g];m(y=>{if(y.includes(a))return y.filter(C=>!C.startsWith(a));{let C=c.filter(E=>E.path.startsWith(a)).map(E=>E.path);return[...y,...C.filter(E=>!y.includes(E))]}})}}),o==="table"){let i=c.map((s,a)=>f.includes(s.path)?a:-1).filter(s=>s!==-1);return de(qe,{data:c,columns:n,selectedRows:i,cursor:g,padding:4,getCellPadding:(s,a,y)=>y===0?4:0,renderCell:(s,a,y,P,C)=>{if(C===0){let{option:E,path:_,depth:he}=y,xe=f.includes(_),L=P===g;return de(z,{label:E.label,checked:xe,paddingLeft:he*et,hasCursor:L},_)}return l==null?void 0:l(s,a,y,P,C)},getCellValue:(s,a,y)=>a.option[s]})}return de(ho,{flexDirection:"column",children:c.map((i,s)=>{let{option:a,path:y,depth:P}=i,C=f.includes(y),E=s===g;return de(z,{label:a.label,checked:C,paddingLeft:P*et,hasCursor:E},y)})})},tt=yo;import{useMemo as ko}from"react";var ge="https://raw.githubusercontent.com/LegendApp/legend-kit/refs/heads/main/";import ot from"fs";import{createHash as To}from"crypto";import{join as Co}from"path";function bo(e){try{let r=ot.readFileSync(e).toString().replace(/\r\n/g,`
`),o=To("sha256");return o.update(r),o.digest("hex")}catch{return""}}function Po(e,t){let{file:r,sha:o,dir:n}=e,l=Co(t,n||"",r);try{if(ot.accessSync(l),bo(l)!==o)return!0}catch{return!0}return!1}function rt(){let{data:e,error:t,isLoading:r}=ue(`${ge}registry.json`),{config:o}=O(),{basePath:n}=o,{options:l,registry:f}=ko(()=>{if(!(e!=null&&e.packages)||!n)return{options:[],registry:{}};let m={},g={},p=[];return e.packages.forEach(u=>{if(!Po(u,n))return;let d={label:u.name,value:u.name,package:u,...u};if(u.dir){let i=u.dir;g[i]||(g[i]=[]),g[i].push(d)}else p.push(d);m[u.dir?`${u.dir}/${u.name}`:u.name]=u}),{options:[...Object.entries(g).map(([u,d])=>({label:u,children:d.sort((i,s)=>i.label.localeCompare(s.label)),package:void 0})),...p].sort((u,d)=>u.label.localeCompare(d.label)),registry:m}},[e,n]);return{options:l,registry:f,error:t,isLoading:r}}import{Box as te,Text as Y}from"ink";import{useEffect as So,useState as wo}from"react";import we from"fs/promises";import oe from"path";import{Spinner as Eo}from"@inkjs/ui";import{jsx as $,jsxs as re}from"react/jsx-runtime";function Ee({packages:e,registry:t,onComplete:r}){let{config:o,proConfig:n}=O(),[l,f]=wo(()=>{let c={};return e.forEach(h=>{let u=h.dir?`${h.dir}/${h.name}`:h.name;c[u]="pending"}),{packageStatus:c,errors:{}}}),m=e.some(c=>c.pro),g=m&&n;if(So(()=>{!o||!g||vo({packages:e,registry:t,config:o,proConfig:n,onUpdateStatus:(c,h,u)=>{f(d=>{let i={...d.packageStatus,[c]:h},s={...d.errors};return u?s[c]=u.message:h!=="error"&&c in s&&delete s[c],h==="success"&&Object.values(i).every(a=>a==="success")&&setTimeout(()=>{r()},0),{packageStatus:i,errors:s}})}})},[g,o]),m&&!n)return $(W,{text:"Connecting to Legend Kit server...",timeout:1e4,timeoutText:"Failed to connect to Legend Kit server. Please check your connection."});let p=Object.values(l.packageStatus).reduce((c,h)=>(c[h]++,c),{pending:0,installing:0,success:0,error:0});return re(te,{flexDirection:"column",children:[re(Y,{bold:!0,children:["Installing packages... (",p.success+p.error,"/",e.length,")"]}),$(te,{flexDirection:"column",marginTop:1,children:e.map(c=>{let h=c.dir?`${c.dir}/${c.name}`:c.name,u=l.packageStatus[h],d=l.errors[h];return re(te,{flexDirection:"row",children:[re(te,{width:2,marginRight:1,children:[u==="installing"&&$(Eo,{}),u==="success"&&$(Y,{color:"green",children:"\u2713"}),u==="error"&&$(Y,{color:"red",children:"\u2717"}),u==="pending"&&$(Y,{color:"gray",children:"\u22EF"})]}),re(te,{flexDirection:"column",children:[$(Y,{dimColor:u!=="success",children:h}),d&&$(Y,{color:"red",dimColor:!0,children:d})]})]},h)})})]})}async function vo({packages:e,registry:t,config:r,proConfig:o,onUpdateStatus:n}){let l=`${ge}packages/`,{basePath:f}=r;if(!f)throw new Error("Base path not defined in config");let m=new Set,g=p=>{p&&(m.add(p),p.imports&&p.imports.length>0&&p.imports.forEach(c=>{let h=t[c]||t[`${p.dir}/${c}`];h&&!m.has(h)&&g(h)}))};e.forEach(p=>g(p)),await Promise.all(Array.from(m).map(async p=>{let c=p.dir?`${p.dir}/${p.name}`:p.name,h=p.pro?o.baseUrl:l;n==null||n(c,"installing");try{let u=oe.join(f,p.dir||""),d=p.file;if(!d)throw new Error(`No file defined for package: ${c}`);let i=d.includes("/")?"..":"",s=oe.join(u,i,d);try{try{await we.access(oe.dirname(s))}catch{await we.mkdir(oe.dirname(s),{recursive:!0})}}catch(C){throw new Error(`Failed to create directory: ${C instanceof Error?C.message:String(C)}`)}let a=oe.join(h,p.dir||"",i,d),y;if(p.pro?y=await fetch(a,{headers:{Authorization:`token ${o.token}`,Accept:"application/vnd.github.v3.raw"}}):y=await fetch(a),!y.ok)throw new Error(`Failed to fetch ${d}: ${y.status} ${y.statusText}`);let P=await y.text();await we.writeFile(s,P,"utf-8"),n==null||n(c,"success")}catch(u){n==null||n(c,"error",u instanceof Error?u:new Error(String(u)))}}))}import{jsx as S,jsxs as G}from"react/jsx-runtime";var at=({input:e})=>{let{options:t,registry:r,error:o,isLoading:n}=rt(),{exit:l}=it(),[f,m]=Z(null),[g,p]=Z(!1),[c,h]=Z(o),u=Ao(!1),d=e.length>1?e.slice(1):[];Oo(()=>{if(u.current||n||o||!r||d.length===0)return;u.current=!0;let s=[],a=[];d.forEach(y=>{let P=Object.values(r).find(C=>C.name===y||C.dir&&`${C.dir}/${C.name}`===y);P?s.push(P):a.push(y)}),a.length>0?h(new Error(`Packages not found: ${a.join(", ")}`)):s.length>0?m(s):setTimeout(()=>{l()},1e3)},[n,o,r,d,l]);let i=()=>{p(!0),setTimeout(()=>{l()},1e3)};return g?S(B,{children:"Installation complete"}):f?S(Ee,{packages:f,registry:r,onComplete:i}):n?S(W,{}):c||o?(setTimeout(()=>{l()},1e3),S(j,{children:G(B,{children:["Error: ",(c==null?void 0:c.message)||(o==null?void 0:o.message)]})})):d.length>0&&u.current?S(j,{children:S(B,{children:"No packages found to install."})}):t?S(Ro,{options:t,registry:r}):null};function Ro({options:e,registry:t}){let{exit:r}=it(),{authConfig:o}=O(),n=!!(o!=null&&o.apiKey),[l,f]=Z([]),[m,g]=Z(null),[p,c]=Z(!1),h=l.map(a=>t[a]).filter(Boolean),u=()=>{h.length>0&&g(h)};Fo((a,y)=>{a==="p"&&Bo("https://www.legendapp.com/kit")});let d=()=>{c(!0),setTimeout(()=>{r()},1e3)},i=nt(()=>{let a=[{label:"Package",key:"name"},{label:"Platform",key:"platform"},{label:"Type",key:"type"},{label:"Pro",key:"pro"},{label:"Description",key:"description"}];return n?a:a.filter(y=>y.key!=="pro")},[n]),s=nt(()=>{let a=y=>y.reduce((P,C)=>{var E;return P+((E=C.package)!=null&&E.pro?1:0)+(C.children?a(C.children):0)},0);return n?0:a(e)},[e,n]);return p?S(B,{children:"Installation complete"}):m?S(Ee,{packages:m,registry:t,onComplete:d}):G(j,{flexDirection:"column",children:[G(j,{children:[S(j,{marginRight:1,children:S(B,{color:"green",children:"?"})}),S(B,{bold:!0,children:"Select packages to install. "}),G(B,{children:["(Press ",S(B,{color:"cyan",children:"<Space>"})," to select, ",S(B,{color:"blue",children:"<a>"})," to toggle all)"]})]}),S(j,{marginTop:1,children:S(tt,{mode:"table",columns:i,options:e,onChange:f,onEnter:u})}),S(j,{flexDirection:"column",marginTop:1,children:G(B,{bold:!0,dimColor:l.length===0,children:["Press ",S(B,{color:"blue",children:"<Enter>"})," to install ",h.length," packages"]})}),!n&&S(j,{marginTop:1,children:G(B,{dimColor:!0,children:["Excluding ",s," Pro packages. Press ",S(B,{color:"blue",children:"<p>"})," to learn more about Legend Kit Pro."]})})]})}import{Box as ne,Text as M,useInput as Uo}from"ink";import{useState as lt}from"react";import Ko from"node:http";import _o from"open";import Do from"node:crypto";import{EOL as Io,endianness as No}from"node:os";import{baseboard as Lo,bios as Mo,cpu as Jo,osInfo as $o,system as jo}from"systeminformation";async function st(){let{manufacturer:e,model:t,serial:r,uuid:o}=await jo(),{vendor:n,version:l,releaseDate:f}=await Mo(),{manufacturer:m,model:g,serial:p}=await Lo(),{manufacturer:c,brand:h,speedMax:u,cores:d,physicalCores:i,socket:s}=await Jo(),{platform:a,arch:y}=await $o(),P={EOL:Io,endianness:No(),manufacturer:e,model:t,serial:r,uuid:o,vendor:n,biosVersion:l,releaseDate:f,boardManufacturer:m,boardModel:g,boardSerial:p,cpuManufacturer:c,brand:h,speedMax:u.toFixed(2),cores:d,physicalCores:i,socket:s,platform:a,arch:y},C=JSON.stringify(P);return Do.createHash("sha256").update(C).digest("hex")}async function ct(){return new Promise((e,t)=>{let r=Ko.createServer((n,l)=>{try{let m=new URL(n.url||"",`http://${n.headers.host}`).searchParams.get("apiKey");m?(l.writeHead(200,{"Content-Type":"text/html"}),l.end(`
            <html>
              <body>
                <h1>Authentication successful!</h1>
                <p>You can close this window and return to the CLI.</p>
                <script>window.close();</script>
              </body>
            </html>
          `),e(m),r.close()):(l.writeHead(400,{"Content-Type":"text/html"}),l.end(`
            <html>
              <body>
                <h1>Authentication failed</h1>
                <p>No authentication token received. Please try again.</p>
              </body>
            </html>
          `))}catch(f){t(f),l.writeHead(500,{"Content-Type":"text/plain"}),l.end("Authentication error occurred"),r.close()}});r.listen(0,()=>{try{let f=`http://localhost:${r.address().port}`;(async()=>{let m=await st(),p=`https://www.legendapp.com/kit/auth?redirectUri=${encodeURIComponent(f)}#deviceId=${m}`;await _o(p)})()}catch(n){r.close(),t(new Error(`Failed to start authentication process: ${n}`))}});let o=5*60*1e3;setTimeout(()=>{r.close(),t(new Error("Authentication timed out after 5 minutes"))},o)})}import{jsx as A,jsxs as ve}from"react/jsx-runtime";var Vo=({goBack:e})=>{let{authConfigFile:t,authConfig:r}=O(),[o,n]=lt(r!=null&&r.apiKey?"authenticated":"waiting"),[l,f]=lt(null),m=async()=>{try{n("authenticating");let g=await ct();await t.setAuthConfig({apiKey:g}),n("authenticated")}catch(g){n("failed"),f(g.message)}};return Uo((g,p)=>{p.return&&(o==="waiting"||o==="failed"?m():o==="authenticated"&&e())}),l?ve(ne,{flexDirection:"column",children:[A(M,{color:"red",children:"Authentication failed:"}),A(M,{color:"red",children:l}),A(ne,{marginTop:1,children:A(M,{children:"Press Enter to try again"})})]}):o==="waiting"?A(ne,{children:A(M,{children:"Press Enter to open a browser to authenticate"})}):o==="authenticating"?ve(ne,{flexDirection:"column",children:[A(M,{children:"Browser opened for authentication..."}),A(M,{children:"Please complete the login process in your browser."}),A(M,{bold:!0,children:"Waiting for authentication to complete..."})]}):o==="authenticated"?ve(ne,{children:[A(M,{color:"green",children:"You are authenticated! "}),A(M,{children:"Press <Enter> to go back!"})]}):null},ut=Vo;import{Select as Ho}from"@inkjs/ui";import{Box as q,Text as K}from"ink";import{jsx as D,jsxs as ie}from"react/jsx-runtime";var Wo=[{label:"add  - Add a package to your project",value:"add"},{label:"auth - Authenticate with Legend Kit for Pro features",value:"auth"},{label:"exit",value:"exit"}],zo=({setCommand:e})=>ie(q,{flexDirection:"column",children:[D(q,{marginBottom:1,children:D(K,{dimColor:!0,italic:!0,children:"A command-line tool for Legend Kit"})}),ie(q,{flexDirection:"column",marginBottom:1,children:[D(K,{bold:!0,children:"What would you like to do?"}),D(q,{children:D(K,{dimColor:!0,children:"Select a command from the list below to get started"})})]}),D(q,{flexDirection:"column",children:D(Ho,{options:Wo,onChange:e})}),ie(q,{flexDirection:"column",marginY:2,children:[ie(K,{dimColor:!0,children:["Press ",D(K,{bold:!0,children:"\u2191"})," or ",D(K,{bold:!0,children:"\u2193"})," to navigate"]}),ie(K,{dimColor:!0,children:["Press ",D(K,{bold:!0,children:"Enter"})," to select"]})]})]}),ft=zo;import{Text as Ct}from"ink";import Be from"fs";import{Text as yt}from"ink";import me from"path";import{useRef as Xo,useState as Fe}from"react";import{useState as ae}from"react";import{Box as T,Text as w,useInput as dt}from"ink";import{TextInput as Qo}from"@inkjs/ui";import{jsx as x,jsxs as v}from"react/jsx-runtime";var Yo="\u256D",V="\u2502",Go="\u2570";var pt="\u25C8",Zo=({value:e,placeholder:t,onSubmit:r,onChange:o,error:n})=>v(T,{flexDirection:"column",children:[x(Qo,{placeholder:t,defaultValue:e,onSubmit:r,onChange:o}),n&&x(T,{marginTop:1,children:x(w,{color:"red",children:n})})]}),qo=({value:e,onChange:t,error:r})=>{let[o,n]=ae(e===!1?"no":"yes");dt((m,g)=>{g.leftArrow?n("yes"):g.rightArrow?n("no"):g.return?t(o==="yes"):m==="y"||m==="Y"?t(!0):(m==="n"||m==="N")&&t(!1)});let l=o==="yes",f=o==="no";return v(T,{flexDirection:"column",children:[v(T,{flexDirection:"row",children:[x(T,{children:x(z,{label:"Yes",checked:l,paddingLeft:0,hasCursor:l})}),x(w,{children:" / "}),x(T,{children:x(z,{label:"No",checked:f,paddingLeft:0,hasCursor:f})})]}),r&&x(T,{marginTop:1,children:x(w,{color:"red",children:r})})]})},se=({title:e,questions:t,onSubmit:r,onCancel:o})=>{let[n,l]=ae(0),[f,m,g]=U({}),[p,c]=ae(""),[h,u,d]=U(null),[i,s]=ae(0),[a,y]=ae(null);dt((b,k)=>{k.escape&&o&&o(),k.upArrow&&E()});let P=(b,k)=>{m(F=>({...F,[b]:k}))},C=()=>{if(n<t.length&&t[n]){let k=t[n],F;if(k.type==="boolean"?F=d.current??k.placeholder:F=p||k.placeholder||"",k.validate){let R=k.validate(F);if(R!==!0){y(R);return}}y(null),P(k.id,F)}let b=n+1;for(;b<t.length;){let k=t[b];if(k&&k.skip&&k.skip())b++;else break}if(b<t.length){l(b);let k=t[b];(k==null?void 0:k.default)!==void 0?k.type==="boolean"?u(k.default??null):c(k.default??""):(c(""),u(null)),s(F=>F+1)}else r(g.current)},E=()=>{if(n>0){let b=n-1;for(;b>=0;){let k=t[b];if(k&&k.skip&&k.skip())b--;else break}if(b>=0){l(b);let k=t[b];if(k){let F=k.id;if(k.type==="boolean"){let R=f[F]??k.placeholder;u(typeof R=="boolean"?R:null)}else{let R=f[F];c(typeof R=="string"?R:"")}s(R=>R+1)}}}},_=b=>{c(b)},he=b=>{u(b),C()},xe=()=>{C()},L=t[n];if(!L)return x(w,{children:"No questions available"});let Ft=L.type==="boolean",Ot=t.slice(0,n),At=(b,k)=>k===void 0?"":b==="boolean"?k===!0?"Yes":"No":String(k);return v(T,{flexDirection:"column",children:[v(T,{flexDirection:"row",children:[x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:Yo})}),x(T,{marginLeft:2,children:v(w,{backgroundColor:"cyan",bold:!0,children:[" ",e," "]})})]}),x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:V})})}),Ot.map((b,k)=>v(T,{flexDirection:"column",children:[x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:V})})}),v(T,{flexDirection:"row",gap:1,children:[x(w,{color:"green",children:pt}),v(w,{dimColor:!0,children:[" ",b.prompt]})]}),v(T,{flexDirection:"row",gap:1,children:[x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:V})}),x(T,{marginLeft:2,children:f[b.id]!==void 0?x(w,{color:"gray",children:At(b.type,f[b.id])}):null})]}),x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:V})})})]},`past-${b.id}`)),v(T,{flexDirection:"column",children:[x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{dimColor:!0,children:V})})}),v(T,{flexDirection:"row",gap:1,children:[x(w,{color:"blue",bold:!0,children:pt}),v(T,{children:[v(w,{color:"white",bold:!0,children:[" ",L.prompt]}),L.helperText&&v(w,{color:"gray",italic:!0,children:[" ","(",L.helperText,")"]})]})]}),v(T,{flexDirection:"row",children:[x(T,{width:1,alignItems:"center",children:x(w,{color:"blue",bold:!0,children:V})}),x(T,{marginLeft:2,children:Ft?x(qo,{value:L.placeholder,onChange:he,error:a||void 0},i):x(Zo,{placeholder:L.placeholder,value:p,onSubmit:xe,onChange:_,error:a||void 0},i)})]}),x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{color:"blue",bold:!0,children:V})})})]}),x(T,{flexDirection:"row",children:x(T,{width:1,alignItems:"center",children:x(w,{color:"blue",bold:!0,children:Go})})})]})};function gt(e,t){if(!e.packageJSON)return!1;let{packageJSON:r}=e;return!!(r.scripts&&r.scripts[t])}async function mt({packageFile:e,scriptName:t,scriptCommand:r="npx legend-kit"}){if(!e.packageJSON)throw new Error("Package.json not loaded");try{let{packageJSON:o}=e,n={...o.scripts||{},[t]:r};await e.setPackageValue("scripts",n)}catch(o){let n=o instanceof Error?o.message:String(o);throw new Error(`Failed to update package.json script: ${n}`)}}function ht({tsConfigFile:e}){var r;if(!e.tsConfig)return!1;let t=(r=e.tsConfig.compilerOptions)==null?void 0:r.paths;return!(!t||!t["@legend-kit"])}async function xt({tsConfigFile:e,config:t}){if(!e.tsConfig)throw console.error(e),new Error("TSConfig not loaded");try{let r={...e.tsConfig};r.compilerOptions||(r.compilerOptions={paths:{}}),r.compilerOptions.paths||(r.compilerOptions.paths={}),r.compilerOptions.paths={...r.compilerOptions.paths,"@legend-kit":[t.basePath]},await e.setConfig(r)}catch(r){let o=r instanceof Error?r.message:String(r);throw new Error(`Failed to update tsconfig.json: ${o}`)}}import{Fragment as kt,jsx as ce,jsxs as Oe}from"react/jsx-runtime";function Tt({configFile:e,tsConfigFile:t,packageFile:r}){let o=Xo(!1),[n,l]=Fe(!1),[f,m]=Fe(null),[g,p]=Fe(!1),c=[{id:"basePath",prompt:"Where should we install the packages?",placeholder:"./legend-kit",type:"text"},{id:"auth",prompt:"Do you want to authenticate with your account to access Pro packages?",placeholder:!1,type:"boolean"},{id:"tsconfigPath",prompt:"Where is your tsconfig.json file?",placeholder:t.filename||"./tsconfig.json",type:"text",validate:d=>{let i=d;if(!i||i.trim()==="")return"Please provide a path to your tsconfig.json file";let s=me.isAbsolute(i)?i:me.resolve(process.cwd(),i);return Be.existsSync(s)?s.endsWith(".json")?!0:"The file must be a JSON file":`File not found at: ${s}`}},{id:"scriptName",prompt:"What script name would you like to add to package.json to run legend kit? (leave blank to skip)",default:"legend",type:"text",validate:d=>{let i=d;return o.current=i.trim()==="",i.trim()===""||/^[a-zA-Z0-9_-]+$/.test(i)?!0:"Script name can only contain letters, numbers, dashes, and underscores"}},{id:"packageJsonPath",prompt:"Where is your package.json file?",placeholder:"./package.json",type:"text",skip:()=>o.current,validate:d=>{let i=d;if(!i||i.trim()==="")return"Please provide a path to your package.json file";let s=me.isAbsolute(i)?i:me.resolve(process.cwd(),i);if(!Be.existsSync(s))return`File not found at: ${s}`;if(!s.endsWith(".json"))return"The file must be a JSON file";try{let a=JSON.parse(Be.readFileSync(s,"utf8"));if(!(a.name||a.private||a.scripts||a.dependencies||a.devDependencies))return"Invalid package.json file"}catch(a){return`Invalid JSON file: ${a.message}`}return!0}}],h=(d,i,s)=>new Promise((a,y)=>{let P=setTimeout(()=>{y(new Error(s))},i);d.then(C=>{clearTimeout(P),a(C)}).catch(C=>{clearTimeout(P),y(C)})}),u=async d=>{l(!0),m(null);let i={configSaved:!1,tsConfigUpdated:!1,packageUpdated:!1};try{let s=o.current;try{await h(e.setConfig({basePath:d.basePath,authenticate:d.auth,tsconfigPath:d.tsconfigPath,scriptName:s?void 0:d.scriptName,packageJsonPath:s?void 0:d.packageJsonPath}),1e4,"Config save operation timed out"),i.configSaved=!0}catch(a){throw new Error(`Failed to save configuration: ${a instanceof Error?a.message:String(a)}`)}try{ht({tsConfigFile:t})||await h(xt({tsConfigFile:t,config:e.config}),1e4,"TSConfig update operation timed out"),i.tsConfigUpdated=!0}catch(a){console.error("TSConfig update failed:",a)}if(s)i.packageUpdated=!0;else try{let a=d.scriptName;gt(r,a)||await h(mt({packageFile:r,scriptName:a,scriptCommand:"npx @legendapp/kit@latest"}),1e4,"Package.json update operation timed out"),i.packageUpdated=!0}catch(a){console.error("Package.json update failed:",a)}p(!0)}catch(s){let a=s instanceof Error?s.message:String(s);i.configSaved&&(a+=`
Config was saved successfully.`),i.tsConfigUpdated&&(a+=`
TSConfig was updated successfully.`),i.packageUpdated&&(a+=`
Package.json was updated successfully.`),m(new Error(a))}finally{l(!1)}};return n?ce(se,{title:"Initializing Legend Kit...",questions:c,onSubmit:u}):f?Oe(kt,{children:[ce(se,{title:"Initializing Legend Kit...",questions:c,onSubmit:u}),Oe(yt,{color:"red",children:["Error during initialization: ",f.message]})]}):g?Oe(kt,{children:[ce(se,{title:"Initializing Legend Kit...",questions:c,onSubmit:u}),ce(yt,{color:"green",children:"\u2713 Legend Kit initialized successfully!"})]}):ce(se,{title:"Initializing Legend Kit...",questions:c,onSubmit:u})}import{jsx as Ae,jsxs as er}from"react/jsx-runtime";function Re(){let e=De(),{configFile:t,tsConfigFile:r,packageFile:o}=O();return e==="config-loading"?Ae(W,{text:"Loading config..."}):e==="config-error"?er(Ct,{color:"red",children:["Error: ",t.error.message]}):e==="config-missing"?Ae(Tt,{configFile:t,tsConfigFile:r,packageFile:o}):Ae(Ct,{children:"Legend Kit is already initialized"})}function De(){let{configFile:e}=O();return e.isLoading?"config-loading":e.error?"config-error":e.config?!1:"config-missing"}import{Box as tr,Text as or}from"ink";import{jsx as bt}from"react/jsx-runtime";var rr=()=>bt(tr,{children:bt(or,{children:"status"})}),Pt=rr;import{Box as le,Text as St}from"ink";import Ie from"ink-gradient";import nr from"ink-big-text";import{jsx as I,jsxs as ir}from"react/jsx-runtime";function wt(){return I(le,{flexDirection:"column",marginBottom:1,children:ir(le,{flexDirection:"column",children:[I(le,{children:I(Ie,{name:"vice",children:I(St,{bold:!0,children:"\u256D\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256E"})})}),I(le,{marginTop:-2,marginBottom:-1,flexDirection:"row",children:I(Ie,{name:"vice",children:I(nr,{text:"Legend Kit",font:"simple"})})}),I(le,{children:I(Ie,{name:"vice",children:I(St,{bold:!0,children:"\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256F"})})})]})})}import{useEffect as lr}from"react";import{jsx as N,jsxs as fr}from"react/jsx-runtime";function Ne({input:e,flags:t}){var f;let{exit:r}=sr(),[o,n,l]=U(((f=e[0])==null?void 0:f.toLowerCase())||null);return cr((m,g)=>{g.escape&&l.current?n(null):(g.escape||g.ctrl&&m==="c")&&r()}),lr(()=>{o==="exit"&&r()},[o]),N(fe,{children:N(ze,{input:e,flags:t,children:fr(ar,{padding:1,flexDirection:"column",children:[N(wt,{}),N(ur,{command:o,setCommand:n,input:e})]})})})}function ur({command:e,setCommand:t,input:r}){if(De())return N(Re,{});switch(e){case"add":return N(at,{input:r});case"auth":return N(ut,{goBack:()=>t(null)});case"status":return N(Pt,{});case"init":return N(Re,{});default:return N(ft,{setCommand:t})}}import{jsx as xr}from"react/jsx-runtime";process.on("uncaughtException",e=>{console.error("Uncaught Exception:"),console.error(e),process.exit(1)});process.on("unhandledRejection",(e,t)=>{console.error("Unhandled Promise Rejection:"),console.error("Promise:",t),console.error("Reason:",e),process.exit(1)});function mr(){let e=process.argv.slice(2),t=[],r={};for(let o of e)if(o.startsWith("--")){let n=o.slice(2),l=n.indexOf("=");if(l!==-1){let f=n.slice(0,l),m=n.slice(l+1);r[f]=m}else r[n]=!0}else o==="-v"||o==="-version"?r.version=!0:t.push(o);return{input:t,flags:r}}function hr(){try{let e=gr(import.meta.url),t=Et.dirname(e),r=Et.resolve(t,"package.json");return JSON.parse(dr.readFileSync(r,"utf8")).version||"unknown"}catch(e){return console.error("Error reading package version:",e),"unknown"}}var{input:vt,flags:Bt}=mr();Bt.version&&vt.length===0&&(console.log(`v${hr()}`),process.exit(0));try{pr(xr(Ne,{input:vt,flags:Bt}))}catch(e){console.error("Error rendering application:"),console.error(e),process.exit(1)}
