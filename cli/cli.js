#!/usr/bin/env node
import{render as or}from"ink";import{Box as Zo,useApp as qo,useInput as Xo}from"ink";import{useCallback as Bt,useRef as Ft,useState as vt}from"react";function G(e){let[t,n]=vt(e),o=Ft(e);o.current=t;let r=Bt(a=>{o.current=typeof a=="function"?a(o.current):a,n(o.current)},[]);return[t,r,o]}import{createContext as Wt,useContext as Qt}from"react";import Z from"fs/promises";import he from"path";import{cwd as Ot}from"process";import{useEffect as At,useState as xe}from"react";function Dt(e){return JSON.parse(e)}function Rt(e){return JSON.stringify(e,null,2)}function J(e,t){let[n,o]=xe(null),[r,a]=xe(null),[d,m]=xe(!0),p=e?he.isAbsolute(e)?e:he.join(Ot(),e):void 0,g=t==="json"?Rt:void 0;return At(()=>{(async()=>{if(!p){m(!1);return}try{m(!0);try{await Z.mkdir(he.dirname(p),{recursive:!0}),await Z.access(p)}catch{m(!1);return}let u=await Z.readFile(p,"utf-8"),i=t==="json"?Dt(u):void 0;o(i),a(null)}catch(u){a(u instanceof Error?u:new Error(String(u)))}finally{m(!1)}})()},[p]),{filename:e,data:n,error:r,isLoading:d,setData:async c=>{try{o(c),await Z.writeFile(p,g(c))}catch(u){a(u instanceof Error?u:new Error(String(u))),o(n)}},updateData:async(c,u)=>{if(!n)throw new Error("Cannot update data that has not been loaded");try{let i={...n,[c]:u};o(i),await Z.writeFile(p,g(i))}catch(i){a(i instanceof Error?i:new Error(String(i))),o(n)}}}}var It="legend-kit.json";function Ne(){let{data:e,error:t,isLoading:n,updateData:o,setData:r}=J(It,"json");return{config:e,error:t,isLoading:n,setConfigValue:o,setConfig:r}}import*as Le from"fs";import Nt from"path";import{cwd as Lt}from"process";function Me(e){let{data:t,error:n,isLoading:o,updateData:r,setData:a,filename:d}=J(Mt(e),"json");return{tsConfig:t,error:n,isLoading:o,setConfigValue:r,setConfig:a,filename:d}}function Mt(e){let t=(e==null?void 0:e.tsconfigPath)??"./tsconfig.json",n=Nt.join(Lt(),t);try{return Le.accessSync(n),t}catch{return null}}import Jt from"env-paths";import $t from"path";var jt=Jt("legend-kit"),Kt="auth";function Je(){let{data:e,error:t,isLoading:n,setData:o}=J($t.join(jt.data,Kt),"json");return{config:e,error:t,isLoading:n,setAuthConfig:o}}import{useState as ye,useEffect as _t}from"react";import Ut from"fs/promises";import Vt from"path";function ce(e,t={}){let[n,o]=ye(null),[r,a]=ye(!0),[d,m]=ye(null),p=void 0;return t.body&&(t.method="POST"),_t(()=>{e&&(async()=>{try{a(!0);let s;if(p){let c=new URL(e).pathname.split("/"),u=c[c.length-1]||"index.json",i=Vt.join(process.cwd(),"testdata",u);try{let l=await Ut.readFile(i,"utf-8");s=JSON.parse(l)}catch(l){throw new Error(`Failed to read test data file: ${i}. ${l instanceof Error?l.message:String(l)}`)}}else{let h={method:t.method||"GET",headers:{"Content-Type":"application/json"}};t.method==="POST"&&t.body&&(h.body=JSON.stringify(t.body));let c=await fetch(e,h);if(!c.ok)throw new Error(`HTTP error! Status: ${c.status}`);s=await c.json()}o(s),m(null)}catch(s){m(s instanceof Error?s:new Error(String(s))),o(null)}finally{a(!1)}})()},[e,p]),{data:n,isLoading:r,error:d}}function $e(e){return ce(e?"http://localhost:8000/api/json/getRepoDownloadUrl":null,{body:{apiKey:e}})}import je from"fs";import Ke from"path";import{cwd as _e}from"process";function Ue(e){let{data:t,error:n,isLoading:o,updateData:r,setData:a,filename:d}=J(Ht(e),"json");return{packageJSON:t,error:n,isLoading:o,setPackageValue:r,setPackage:a,filename:d}}function Ht(e){let t=(e==null?void 0:e.packageJsonPath)??"./package.json",n=Ke.join(_e(),t);try{return je.accessSync(n),t}catch{try{let r="./package.json";return je.accessSync(Ke.join(_e(),r)),r}catch{return t}}}import{jsx as zt}from"react/jsx-runtime";var Ve=Wt(void 0);function He({flags:e,children:t}){var p;let n=Ne(),o=Me(n.config||{}),r=Je(),a=Ue(n.config||{}),{data:d}=$e(((p=r==null?void 0:r.config)==null?void 0:p.apiKey)||""),m={testData:e.useTestData,configFile:n,config:n.config,tsConfig:o.tsConfig,tsConfigFile:o,authConfig:r.config,authConfigFile:r,proConfig:d,packageJSON:a.packageJSON,packageFile:a};return zt(Ve.Provider,{value:m,children:t})}function v(){let e=Qt(Ve);if(e===void 0)throw new Error("useAppConfig must be used within an AppConfigProvider");return e}import Yt from"react";import{Box as Gt,Text as Te}from"ink";import{jsx as ke,jsxs as Zt}from"react/jsx-runtime";var le=class extends Yt.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,n){console.error("Error caught by ErrorBoundary:",t),console.error("Component stack:",n.componentStack)}render(){var t;return this.state.hasError?this.props.fallback?this.props.fallback:Zt(Gt,{flexDirection:"column",borderStyle:"round",borderColor:"red",padding:1,children:[ke(Te,{bold:!0,color:"red",children:"Something went wrong"}),ke(Te,{color:"red",children:((t=this.state.error)==null?void 0:t.message)||"Unknown error"}),ke(Te,{children:"Please try again or check the logs for more details."})]}):this.props.children}};import ko from"open";import{Box as _,Text as O,useApp as Co,useInput as bo}from"ink";import{useMemo as rt,useState as we}from"react";import{Spinner as qt}from"@inkjs/ui";import{Box as We,Text as Qe}from"ink";import{useEffect as Xt,useState as eo}from"react";import{jsx as ue,jsxs as to}from"react/jsx-runtime";function V({text:e,timeout:t,timeoutText:n}){let[o,r]=eo(!1);return Xt(()=>{if(t){let a=setTimeout(()=>{r(!0)},t);return()=>{clearTimeout(a)}}},[t]),to(We,{children:[ue(We,{marginRight:1,children:o?ue(Qe,{color:"red",children:"\u274C"}):ue(qt,{type:"dotsCircle"})}),ue(Qe,{color:o?"red":void 0,children:o?n||"Operation timed out":e||"Loading..."})]})}import{Box as so,useInput as co}from"ink";import{useEffect as Ze,useState as Pe}from"react";import ze from"figures";import{Box as oo,Text as Ce}from"ink";import{jsx as be,jsxs as io}from"react/jsx-runtime";var ro=ze.circle,no=ze.radioOn;function H({label:e,checked:t,paddingLeft:n,hasCursor:o}){return be(oo,{paddingLeft:n,children:io(Ce,{children:[be(Ce,{color:"green",children:t?no:ro})," ",be(Ce,{bold:o,dimColor:!o,children:e})]})})}import{Box as q,Text as Ye}from"ink";import{jsx as W,jsxs as ao}from"react/jsx-runtime";function Ge({data:e,columns:t,selectedRows:n=[],cursor:o=-1,padding:r=2,renderCell:a,getCellValue:d,getCellPadding:m}){let p=t.map((g,s)=>{let h=e.map(c=>{let u=m?m(g.key,c,s):0,i=d?d(g.key,c,s):String(c[g.key]);return typeof i=="string"?i.length+u:0});return Math.max(g.label.length,...h)+r});return ao(q,{flexDirection:"column",children:[W(q,{marginBottom:1,children:t.map((g,s)=>W(q,{width:p[s],children:W(Ye,{bold:!0,children:g.label})},s))}),e.map((g,s)=>{let h=s===o;return W(q,{children:t.map((c,u)=>{let i=d(c.key,g,s);typeof i=="boolean"&&(i=i?"Yes":"No");let l=a&&a(c.key,i,g,s,u);return W(q,{width:p[u],children:l||W(Ye,{dimColor:!h,children:i})},u)})},s)})]})}import{jsx as fe}from"react/jsx-runtime";var qe=2,lo=({options:e,onChange:t,onEnter:n,mode:o="checkbox",columns:r,renderCell:a})=>{let[d,m]=Pe([]),[p,g]=Pe(0),[s,h]=Pe([]);Ze(()=>{let i=u(e);h(i)},[e]),Ze(()=>{t(d)},[d,t]);let c=i=>i.value||i.label,u=(i,l="",f=0)=>i.flatMap(y=>{var K;let S=c(y),C=l?`${l}/${S}`:S,w=[{option:y,path:C,depth:f}];return(K=y.children)!=null&&K.length&&w.push(...u(y.children,C,f+1)),w});if(co((i,l)=>{if(l.upArrow)g(f=>Math.max(0,f-1));else if(l.downArrow)g(f=>Math.min(s.length-1,f+1));else if(l.return)n();else if(i==="a")d.length===s.length?m([]):m(s.map(f=>f.path));else if(i===" "){let{path:f}=s[p];m(y=>{if(y.includes(f))return y.filter(C=>!C.startsWith(f));{let C=s.filter(w=>w.path.startsWith(f)).map(w=>w.path);return[...y,...C.filter(w=>!y.includes(w))]}})}}),o==="table"){let i=s.map((l,f)=>d.includes(l.path)?f:-1).filter(l=>l!==-1);return fe(Ge,{data:s,columns:r,selectedRows:i,cursor:p,padding:4,getCellPadding:(l,f,y)=>y===0?4:0,renderCell:(l,f,y,S,C)=>{if(C===0){let{option:w,path:K,depth:ge}=y,me=d.includes(K),L=S===p;return fe(H,{label:w.label,checked:me,paddingLeft:ge*qe,hasCursor:L},K)}return a==null?void 0:a(l,f,y,S,C)},getCellValue:(l,f,y)=>f.option[l]})}return fe(so,{flexDirection:"column",children:s.map((i,l)=>{let{option:f,path:y,depth:S}=i,C=d.includes(y),w=l===p;return fe(H,{label:f.label,checked:C,paddingLeft:S*qe,hasCursor:w},y)})})},Xe=lo;import{useMemo as uo}from"react";var de="https://raw.githubusercontent.com/LegendApp/legend-kit/refs/heads/main/";import et from"fs";import{createHash as fo}from"crypto";import{join as po}from"path";function go(e){try{let n=et.readFileSync(e).toString().replace(/\r\n/g,`
`),o=fo("sha256");return o.update(n),o.digest("hex")}catch{return""}}function mo(e,t){let{file:n,sha:o,dir:r}=e,a=po(t,r||"",n);try{if(et.accessSync(a),go(a)!==o)return!0}catch{return!0}return!1}function tt(){let{data:e,error:t,isLoading:n}=ce(`${de}registry.json`),{config:o}=v(),{basePath:r}=o,{options:a,registry:d}=uo(()=>{if(!(e!=null&&e.packages)||!r)return{options:[],registry:{}};let m={},p={},g=[];return e.packages.forEach(c=>{if(!mo(c,r))return;let u={label:c.name,value:c.name,package:c,...c};if(c.dir){let i=c.dir;p[i]||(p[i]=[]),p[i].push(u)}else g.push(u);m[c.dir?`${c.dir}/${c.name}`:c.name]=c}),{options:[...Object.entries(p).map(([c,u])=>({label:c,children:u.sort((i,l)=>i.label.localeCompare(l.label)),package:void 0})),...g].sort((c,u)=>c.label.localeCompare(u.label)),registry:m}},[e,r]);return{options:a,registry:d,error:t,isLoading:n}}import{Box as X,Text as Q}from"ink";import{useEffect as ho,useState as xo}from"react";import Se from"fs/promises";import ee from"path";import{Spinner as yo}from"@inkjs/ui";import{jsx as $,jsxs as te}from"react/jsx-runtime";function ot({packages:e,registry:t,onComplete:n}){let{config:o,proConfig:r}=v(),[a,d]=xo(()=>{let s={};return e.forEach(h=>{let c=h.dir?`${h.dir}/${h.name}`:h.name;s[c]="pending"}),{packageStatus:s,errors:{}}}),m=e.some(s=>s.pro),p=m&&r;if(ho(()=>{!o||!p||To({packages:e,registry:t,config:o,proConfig:r,onUpdateStatus:(s,h,c)=>{d(u=>{let i={...u.packageStatus,[s]:h},l={...u.errors};return c?l[s]=c.message:h!=="error"&&s in l&&delete l[s],h==="success"&&Object.values(i).every(f=>f==="success")&&setTimeout(()=>{n()},0),{packageStatus:i,errors:l}})}})},[p,o]),m&&!r)return $(V,{text:"Connecting to Legend Kit server...",timeout:1e4,timeoutText:"Failed to connect to Legend Kit server. Please check your connection."});let g=Object.values(a.packageStatus).reduce((s,h)=>(s[h]++,s),{pending:0,installing:0,success:0,error:0});return te(X,{flexDirection:"column",children:[te(Q,{bold:!0,children:["Installing packages... (",g.success+g.error,"/",e.length,")"]}),$(X,{flexDirection:"column",marginTop:1,children:e.map(s=>{let h=s.dir?`${s.dir}/${s.name}`:s.name,c=a.packageStatus[h],u=a.errors[h];return te(X,{flexDirection:"row",children:[te(X,{width:2,marginRight:1,children:[c==="installing"&&$(yo,{}),c==="success"&&$(Q,{color:"green",children:"\u2713"}),c==="error"&&$(Q,{color:"red",children:"\u2717"}),c==="pending"&&$(Q,{color:"gray",children:"\u22EF"})]}),te(X,{flexDirection:"column",children:[$(Q,{dimColor:c!=="success",children:h}),u&&$(Q,{color:"red",dimColor:!0,children:u})]})]},h)})})]})}async function To({packages:e,registry:t,config:n,proConfig:o,onUpdateStatus:r}){let a=`${de}packages/`,{basePath:d}=n;if(!d)throw new Error("Base path not defined in config");let m=new Set,p=g=>{g&&(m.add(g),g.imports&&g.imports.length>0&&g.imports.forEach(s=>{let h=t[s]||t[`${g.dir}/${s}`];h&&!m.has(h)&&p(h)}))};e.forEach(g=>p(g)),await Promise.all(Array.from(m).map(async g=>{let s=g.dir?`${g.dir}/${g.name}`:g.name,h=g.pro?o.baseUrl:a;r==null||r(s,"installing");try{let c=ee.join(d,g.dir||""),u=g.file;if(!u)throw new Error(`No file defined for package: ${s}`);let i=u.includes("/")?"..":"",l=ee.join(c,i,u);try{try{await Se.access(ee.dirname(l))}catch{await Se.mkdir(ee.dirname(l),{recursive:!0})}}catch(C){throw new Error(`Failed to create directory: ${C instanceof Error?C.message:String(C)}`)}let f=ee.join(h,g.dir||"",i,u),y;if(g.pro?y=await fetch(f,{headers:{Authorization:`token ${o.token}`,Accept:"application/vnd.github.v3.raw"}}):y=await fetch(f),!y.ok)throw new Error(`Failed to fetch ${u}: ${y.status} ${y.statusText}`);let S=await y.text();await Se.writeFile(l,S,"utf-8"),r==null||r(s,"success")}catch(c){r==null||r(s,"error",c instanceof Error?c:new Error(String(c)))}}))}import{jsx as E,jsxs as z}from"react/jsx-runtime";var nt=()=>{let{options:e,registry:t,error:n,isLoading:o}=tt();return o?E(V,{}):n?E(_,{children:z(O,{children:["Error: ",n.message]})}):e?E(Po,{options:e,registry:t}):null};function Po({options:e,registry:t}){let{exit:n}=Co(),{authConfig:o}=v(),r=!!(o!=null&&o.apiKey),[a,d]=we([]),[m,p]=we(null),[g,s]=we(!1),h=a.map(f=>t[f]).filter(Boolean),c=()=>{h.length>0&&p(h)};bo((f,y)=>{f==="p"&&ko("https://www.legendapp.com/kit")});let u=()=>{s(!0),setTimeout(()=>{n()},1e3)},i=rt(()=>{let f=[{label:"Package",key:"name"},{label:"Platform",key:"platform"},{label:"Type",key:"type"},{label:"Pro",key:"pro"},{label:"Description",key:"description"}];return r?f:f.filter(y=>y.key!=="pro")},[r]),l=rt(()=>{let f=y=>y.reduce((S,C)=>{var w;return S+((w=C.package)!=null&&w.pro?1:0)+(C.children?f(C.children):0)},0);return r?0:f(e)},[e,r]);return g?E(O,{children:"Installation complete"}):m?E(ot,{packages:m,registry:t,onComplete:u}):z(_,{flexDirection:"column",children:[z(_,{children:[E(_,{marginRight:1,children:E(O,{color:"green",children:"?"})}),E(O,{bold:!0,children:"Select packages to install. "}),z(O,{children:["(Press ",E(O,{color:"cyan",children:"<Space>"})," to select, ",E(O,{color:"blue",children:"<a>"})," to toggle all)"]})]}),E(_,{marginTop:1,children:E(Xe,{mode:"table",columns:i,options:e,onChange:d,onEnter:c})}),E(_,{flexDirection:"column",marginTop:1,children:z(O,{bold:!0,dimColor:a.length===0,children:["Press ",E(O,{color:"blue",children:"<Enter>"})," to install ",h.length," packages"]})}),!r&&E(_,{marginTop:1,children:z(O,{dimColor:!0,children:["Excluding ",l," Pro packages. Press ",E(O,{color:"blue",children:"<p>"})," to learn more about Legend Kit Pro."]})})]})}import{Box as oe,Text as M,useInput as Io}from"ink";import{useState as st}from"react";import Do from"node:http";import Ro from"open";import So from"node:crypto";import{EOL as wo,endianness as Eo}from"node:os";import{baseboard as Bo,bios as Fo,cpu as vo,osInfo as Oo,system as Ao}from"systeminformation";async function it(){let{manufacturer:e,model:t,serial:n,uuid:o}=await Ao(),{vendor:r,version:a,releaseDate:d}=await Fo(),{manufacturer:m,model:p,serial:g}=await Bo(),{manufacturer:s,brand:h,speedMax:c,cores:u,physicalCores:i,socket:l}=await vo(),{platform:f,arch:y}=await Oo(),S={EOL:wo,endianness:Eo(),manufacturer:e,model:t,serial:n,uuid:o,vendor:r,biosVersion:a,releaseDate:d,boardManufacturer:m,boardModel:p,boardSerial:g,cpuManufacturer:s,brand:h,speedMax:c.toFixed(2),cores:u,physicalCores:i,socket:l,platform:f,arch:y},C=JSON.stringify(S);return So.createHash("sha256").update(C).digest("hex")}async function at(){return new Promise((e,t)=>{let n=Do.createServer((r,a)=>{try{let m=new URL(r.url||"",`http://${r.headers.host}`).searchParams.get("apiKey");m?(a.writeHead(200,{"Content-Type":"text/html"}),a.end(`
            <html>
              <body>
                <h1>Authentication successful!</h1>
                <p>You can close this window and return to the CLI.</p>
                <script>window.close();</script>
              </body>
            </html>
          `),e(m),n.close()):(a.writeHead(400,{"Content-Type":"text/html"}),a.end(`
            <html>
              <body>
                <h1>Authentication failed</h1>
                <p>No authentication token received. Please try again.</p>
              </body>
            </html>
          `))}catch(d){t(d),a.writeHead(500,{"Content-Type":"text/plain"}),a.end("Authentication error occurred"),n.close()}});n.listen(0,()=>{try{let d=`http://localhost:${n.address().port}`;(async()=>{let m=await it(),g=`http://localhost:4321/kit/auth?redirectUri=${encodeURIComponent(d)}#deviceId=${m}`;await Ro(g)})()}catch(r){n.close(),t(new Error(`Failed to start authentication process: ${r}`))}});let o=5*60*1e3;setTimeout(()=>{n.close(),t(new Error("Authentication timed out after 5 minutes"))},o)})}import{jsx as A,jsxs as Ee}from"react/jsx-runtime";var No=({goBack:e})=>{let{authConfigFile:t,authConfig:n}=v(),[o,r]=st(n!=null&&n.apiKey?"authenticated":"waiting"),[a,d]=st(null),m=async()=>{try{r("authenticating");let p=await at();await t.setAuthConfig({apiKey:p}),r("authenticated")}catch(p){r("failed"),d(p.message)}};return Io((p,g)=>{g.return&&(o==="waiting"||o==="failed"?m():o==="authenticated"&&e())}),a?Ee(oe,{flexDirection:"column",children:[A(M,{color:"red",children:"Authentication failed:"}),A(M,{color:"red",children:a}),A(oe,{marginTop:1,children:A(M,{children:"Press Enter to try again"})})]}):o==="waiting"?A(oe,{children:A(M,{children:"Press Enter to open a browser to authenticate"})}):o==="authenticating"?Ee(oe,{flexDirection:"column",children:[A(M,{children:"Browser opened for authentication..."}),A(M,{children:"Please complete the login process in your browser."}),A(M,{bold:!0,children:"Waiting for authentication to complete..."})]}):o==="authenticated"?Ee(oe,{children:[A(M,{color:"green",children:"You are authenticated! "}),A(M,{children:"Press <Enter> to go back!"})]}):null},ct=No;import{Select as Lo}from"@inkjs/ui";import{Box as Y,Text as j}from"ink";import{jsx as R,jsxs as re}from"react/jsx-runtime";var Mo=[{label:"add  - Add a package to your project",value:"add"},{label:"auth - Authenticate with Legend Kit for Pro features",value:"auth"},{label:"exit",value:"exit"}],Jo=({setCommand:e})=>re(Y,{flexDirection:"column",children:[R(Y,{marginBottom:1,children:R(j,{dimColor:!0,italic:!0,children:"A command-line tool for Legend Kit"})}),re(Y,{flexDirection:"column",marginBottom:1,children:[R(j,{bold:!0,children:"What would you like to do?"}),R(Y,{children:R(j,{dimColor:!0,children:"Select a command from the list below to get started"})})]}),R(Y,{flexDirection:"column",children:R(Lo,{options:Mo,onChange:e})}),re(Y,{flexDirection:"column",marginY:2,children:[re(j,{dimColor:!0,children:["Press ",R(j,{bold:!0,children:"\u2191"})," or ",R(j,{bold:!0,children:"\u2193"})," to navigate"]}),re(j,{dimColor:!0,children:["Press ",R(j,{bold:!0,children:"Enter"})," to select"]})]})]}),lt=Jo;import{Text as Tt}from"ink";import Be from"fs";import{Text as ht}from"ink";import pe from"path";import{useRef as Vo,useState as Fe}from"react";import{useState as ne}from"react";import{Box as k,Text as P,useInput as ft}from"ink";import{TextInput as $o}from"@inkjs/ui";import{jsx as x,jsxs as B}from"react/jsx-runtime";var jo="\u256D",U="\u2502",Ko="\u2570";var ut="\u25C8",_o=({value:e,placeholder:t,onSubmit:n,onChange:o,error:r})=>B(k,{flexDirection:"column",children:[x($o,{placeholder:t,defaultValue:e,onSubmit:n,onChange:o}),r&&x(k,{marginTop:1,children:x(P,{color:"red",children:r})})]}),Uo=({value:e,onChange:t,error:n})=>{let[o,r]=ne(e===!1?"no":"yes");ft((m,p)=>{p.leftArrow?r("yes"):p.rightArrow?r("no"):p.return?t(o==="yes"):m==="y"||m==="Y"?t(!0):(m==="n"||m==="N")&&t(!1)});let a=o==="yes",d=o==="no";return B(k,{flexDirection:"column",children:[B(k,{flexDirection:"row",children:[x(k,{children:x(H,{label:"Yes",checked:a,paddingLeft:0,hasCursor:a})}),x(P,{children:" / "}),x(k,{children:x(H,{label:"No",checked:d,paddingLeft:0,hasCursor:d})})]}),n&&x(k,{marginTop:1,children:x(P,{color:"red",children:n})})]})},ie=({title:e,questions:t,onSubmit:n,onCancel:o})=>{let[r,a]=ne(0),[d,m,p]=G({}),[g,s]=ne(""),[h,c,u]=G(null),[i,l]=ne(0),[f,y]=ne(null);ft((b,T)=>{T.escape&&o&&o(),T.upArrow&&w()});let S=(b,T)=>{m(F=>({...F,[b]:T}))},C=()=>{if(r<t.length&&t[r]){let T=t[r],F;if(T.type==="boolean"?F=u.current??T.placeholder:F=g||T.placeholder||"",T.validate){let D=T.validate(F);if(D!==!0){y(D);return}}y(null),S(T.id,F)}let b=r+1;for(;b<t.length;){let T=t[b];if(T&&T.skip&&T.skip())b++;else break}if(b<t.length){a(b);let T=t[b];(T==null?void 0:T.default)!==void 0?T.type==="boolean"?c(T.default??null):s(T.default??""):(s(""),c(null)),l(F=>F+1)}else n(p.current)},w=()=>{if(r>0){let b=r-1;for(;b>=0;){let T=t[b];if(T&&T.skip&&T.skip())b--;else break}if(b>=0){a(b);let T=t[b];if(T){let F=T.id;if(T.type==="boolean"){let D=d[F]??T.placeholder;c(typeof D=="boolean"?D:null)}else{let D=d[F];s(typeof D=="string"?D:"")}l(D=>D+1)}}}},K=b=>{s(b)},ge=b=>{c(b),C()},me=()=>{C()},L=t[r];if(!L)return x(P,{children:"No questions available"});let St=L.type==="boolean",wt=t.slice(0,r),Et=(b,T)=>T===void 0?"":b==="boolean"?T===!0?"Yes":"No":String(T);return B(k,{flexDirection:"column",children:[B(k,{flexDirection:"row",children:[x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:jo})}),x(k,{marginLeft:2,children:B(P,{backgroundColor:"cyan",bold:!0,children:[" ",e," "]})})]}),x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:U})})}),wt.map((b,T)=>B(k,{flexDirection:"column",children:[x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:U})})}),B(k,{flexDirection:"row",gap:1,children:[x(P,{color:"green",children:ut}),B(P,{dimColor:!0,children:[" ",b.prompt]})]}),B(k,{flexDirection:"row",gap:1,children:[x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:U})}),x(k,{marginLeft:2,children:d[b.id]!==void 0?x(P,{color:"gray",children:Et(b.type,d[b.id])}):null})]}),x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:U})})})]},`past-${b.id}`)),B(k,{flexDirection:"column",children:[x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{dimColor:!0,children:U})})}),B(k,{flexDirection:"row",gap:1,children:[x(P,{color:"blue",bold:!0,children:ut}),B(k,{children:[B(P,{color:"white",bold:!0,children:[" ",L.prompt]}),L.helperText&&B(P,{color:"gray",italic:!0,children:[" ","(",L.helperText,")"]})]})]}),B(k,{flexDirection:"row",children:[x(k,{width:1,alignItems:"center",children:x(P,{color:"blue",bold:!0,children:U})}),x(k,{marginLeft:2,children:St?x(Uo,{value:L.placeholder,onChange:ge,error:f||void 0},i):x(_o,{placeholder:L.placeholder,value:g,onSubmit:me,onChange:K,error:f||void 0},i)})]}),x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{color:"blue",bold:!0,children:U})})})]}),x(k,{flexDirection:"row",children:x(k,{width:1,alignItems:"center",children:x(P,{color:"blue",bold:!0,children:Ko})})})]})};function dt(e,t){if(!e.packageJSON)return!1;let{packageJSON:n}=e;return!!(n.scripts&&n.scripts[t])}async function pt({packageFile:e,scriptName:t,scriptCommand:n="npx legend-kit"}){if(!e.packageJSON)throw new Error("Package.json not loaded");try{let{packageJSON:o}=e,r={...o.scripts||{},[t]:n};await e.setPackageValue("scripts",r)}catch(o){let r=o instanceof Error?o.message:String(o);throw new Error(`Failed to update package.json script: ${r}`)}}function gt({tsConfigFile:e}){var t;return!(!e.tsConfig||!((t=e.tsConfig.compilerOptions)!=null&&t.paths))}async function mt({tsConfigFile:e}){if(!e.tsConfig)throw new Error("TSConfig not loaded");let t={...e.tsConfig};t.compilerOptions||(t.compilerOptions={paths:{}}),t.compilerOptions.paths||(t.compilerOptions.paths={}),t.compilerOptions.paths={...t.compilerOptions.paths,"@/*":["./src/*"]},await e.setConfig(t)}import{Fragment as xt,jsx as ae,jsxs as ve}from"react/jsx-runtime";function yt({configFile:e,tsConfigFile:t,packageFile:n}){let o=Vo(!1),[r,a]=Fe(!1),[d,m]=Fe(null),[p,g]=Fe(!1),s=[{id:"basePath",prompt:"Where should we install the packages?",placeholder:"./legend-kit",type:"text"},{id:"auth",prompt:"Do you want to authenticate with your account to access Pro packages?",placeholder:!1,type:"boolean"},{id:"tsconfigPath",prompt:"Where is your tsconfig.json file?",placeholder:t.filename||"./tsconfig.json",type:"text",validate:u=>{let i=u;if(!i||i.trim()==="")return"Please provide a path to your tsconfig.json file";let l=pe.isAbsolute(i)?i:pe.resolve(process.cwd(),i);return Be.existsSync(l)?l.endsWith(".json")?!0:"The file must be a JSON file":`File not found at: ${l}`}},{id:"scriptName",prompt:"What script name would you like to add to package.json to run legend kit? (leave blank to skip)",default:"legend",type:"text",validate:u=>{let i=u;return o.current=i.trim()==="",i.trim()===""||/^[a-zA-Z0-9_-]+$/.test(i)?!0:"Script name can only contain letters, numbers, dashes, and underscores"}},{id:"packageJsonPath",prompt:"Where is your package.json file?",placeholder:"./package.json",type:"text",skip:()=>o.current,validate:u=>{let i=u;if(!i||i.trim()==="")return"Please provide a path to your package.json file";let l=pe.isAbsolute(i)?i:pe.resolve(process.cwd(),i);if(!Be.existsSync(l))return`File not found at: ${l}`;if(!l.endsWith(".json"))return"The file must be a JSON file";try{if(!JSON.parse(Be.readFileSync(l,"utf8")).name)return'Invalid package.json file: missing "name" field'}catch(f){return`Invalid JSON file: ${f.message}`}return!0}}],h=(u,i,l)=>new Promise((f,y)=>{let S=setTimeout(()=>{y(new Error(l))},i);u.then(C=>{clearTimeout(S),f(C)}).catch(C=>{clearTimeout(S),y(C)})}),c=async u=>{a(!0),m(null);let i={configSaved:!1,tsConfigUpdated:!1,packageUpdated:!1};try{let l=o.current;try{await h(e.setConfig({basePath:u.basePath,authenticate:u.auth,tsconfigPath:u.tsconfigPath,scriptName:l?void 0:u.scriptName,packageJsonPath:l?void 0:u.packageJsonPath}),1e4,"Config save operation timed out"),i.configSaved=!0}catch(f){throw new Error(`Failed to save configuration: ${f instanceof Error?f.message:String(f)}`)}try{gt({tsConfigFile:t})||await h(mt({tsConfigFile:t}),1e4,"TSConfig update operation timed out"),i.tsConfigUpdated=!0}catch(f){console.error("TSConfig update failed:",f)}if(l)i.packageUpdated=!0;else try{let f=u.scriptName;dt(n,f)||await h(pt({packageFile:n,scriptName:f,scriptCommand:"npx legend-kit"}),1e4,"Package.json update operation timed out"),i.packageUpdated=!0}catch(f){console.error("Package.json update failed:",f)}g(!0)}catch(l){let f=l instanceof Error?l.message:String(l);i.configSaved&&(f+=`
Config was saved successfully.`),i.tsConfigUpdated&&(f+=`
TSConfig was updated successfully.`),i.packageUpdated&&(f+=`
Package.json was updated successfully.`),m(new Error(f))}finally{a(!1)}};return r?ae(ie,{title:"Initializing Legend Kit...",questions:s,onSubmit:c}):d?ve(xt,{children:[ae(ie,{title:"Initializing Legend Kit...",questions:s,onSubmit:c}),ve(ht,{color:"red",children:["Error during initialization: ",d.message]})]}):p?ve(xt,{children:[ae(ie,{title:"Initializing Legend Kit...",questions:s,onSubmit:c}),ae(ht,{color:"green",children:"\u2713 Legend Kit initialized successfully!"})]}):ae(ie,{title:"Initializing Legend Kit...",questions:s,onSubmit:c})}import{jsx as Oe,jsxs as Ho}from"react/jsx-runtime";function Ae(){let e=De(),{configFile:t,tsConfigFile:n,packageFile:o}=v();return e==="config-loading"?Oe(V,{text:"Loading config..."}):e==="config-error"?Ho(Tt,{color:"red",children:["Error: ",t.error.message]}):e==="config-missing"?Oe(yt,{configFile:t,tsConfigFile:n,packageFile:o}):Oe(Tt,{children:"Legend Kit is already initialized"})}function De(){let{configFile:e}=v();return e.isLoading?"config-loading":e.error?"config-error":e.config?!1:"config-missing"}import{Box as Wo,Text as Qo}from"ink";import{jsx as kt}from"react/jsx-runtime";var zo=()=>kt(Wo,{children:kt(Qo,{children:"status"})}),Ct=zo;import{Box as se,Text as bt}from"ink";import Re from"ink-gradient";import Yo from"ink-big-text";import{jsx as I,jsxs as Go}from"react/jsx-runtime";function Pt(){return I(se,{flexDirection:"column",marginBottom:1,children:Go(se,{flexDirection:"column",children:[I(se,{children:I(Re,{name:"vice",children:I(bt,{bold:!0,children:"\u256D\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256E"})})}),I(se,{marginTop:-2,marginBottom:-1,flexDirection:"row",children:I(Re,{name:"vice",children:I(Yo,{text:"Legend Kit",font:"simple"})})}),I(se,{children:I(Re,{name:"vice",children:I(bt,{bold:!0,children:"\u2570\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u256F"})})})]})})}import{jsx as N,jsxs as tr}from"react/jsx-runtime";function Ie({input:e,flags:t}){var d;let{exit:n}=qo(),[o,r,a]=G(((d=e[0])==null?void 0:d.toLowerCase())||null);return Xo((m,p)=>{p.escape&&a.current?r(null):(p.escape||p.ctrl&&m==="c")&&n()}),N(le,{children:N(He,{input:e,flags:t,children:tr(Zo,{padding:1,flexDirection:"column",children:[N(Pt,{}),N(er,{command:o,setCommand:r})]})})})}function er({command:e,setCommand:t}){if(De())return N(Ae,{});switch(e){case"add":return N(nt,{});case"auth":return N(ct,{goBack:()=>t(null)});case"status":return N(Ct,{});case"init":return N(Ae,{});default:return N(lt,{setCommand:t})}}import{jsx as ar}from"react/jsx-runtime";process.on("uncaughtException",e=>{console.error("Uncaught Exception:"),console.error(e),process.exit(1)});process.on("unhandledRejection",(e,t)=>{console.error("Unhandled Promise Rejection:"),console.error("Promise:",t),console.error("Reason:",e),process.exit(1)});function rr(){let e=process.argv.slice(2),t=[],n={};for(let o of e)if(o.startsWith("--")){let r=o.slice(2),a=r.indexOf("=");if(a!==-1){let d=r.slice(0,a),m=r.slice(a+1);n[d]=m}else n[r]=!0}else t.push(o);return{input:t,flags:n}}var{input:nr,flags:ir}=rr();try{or(ar(Ie,{input:nr,flags:ir}))}catch(e){console.error("Error rendering application:"),console.error(e),process.exit(1)}
